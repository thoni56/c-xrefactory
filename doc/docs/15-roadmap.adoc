== Roadmap

This chapter outlines the high-level architectural and feature goals for c-xrefactory. For implementation details, see link:17-major-codebase-improvements.adoc[Chapter 17: Major Codebase Improvements].

=== Guiding Principles

* **Incremental improvement**: Each step should provide immediate value while moving toward long-term goals
* **Test-driven modernization**: Maintain 85%+ test coverage to enable confident refactoring
* **Backward compatibility**: Preserve existing Emacs workflows while enabling modern IDE integration
* **Architectural simplification**: Replace artificial mode distinctions with unified, smart on-demand behavior
* **Legacy code respect**: Work with the existing 1990s codebase thoughtfully, not against it

=== Architectural Vision: Memory as Truth

==== The Goal

**In-memory references become the single source of truth.** Currently, the system has two sources (in-memory `referenceableItemTable` and `.cx` files on disk) with different code paths for navigation vs. refactoring. This creates complexity, bugs, and makes preloaded editor buffers work inconsistently.

==== Dependency Chain

The following diagram shows how the architectural pieces depend on each other. Work proceeds from bottom to top.

----
┌─────────────────────────────────────────────────────────────────────┐
│                    ARCHITECTURAL GOAL                                │
│         "In-memory references are the single source of truth"        │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         REQUIRES                                     │
├─────────────────────────────────────────────────────────────────────┤
│  A. Refactoring uses in-memory table (no callXref)                  │
│  B. Navigation uses in-memory table (no .cx lookups mid-session)    │
│  C. In-memory table is always current for all modified files        │
└─────────────────────────────────────────────────────────────────────┘
         │                    │                         │
         ▼                    ▼                         ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐
│ A. No callXref  │  │ B. Index-based  │  │ C. Table always current │
│ in refactoring  │  │    sessions     │  │                         │
└────────┬────────┘  └────────┬────────┘  └────────────┬────────────┘
         │                    │                         │
         │                    │                         ▼
         │                    │           ┌─────────────────────────┐
         │                    │           │ C1. All modified files  │
         │                    │           │     are preloaded       │
         │                    │           │ (Emacs client change)   │
         │                    │           └────────────┬────────────┘
         │                    │                        │
         │                    │                        ▼
         │                    │           ┌─────────────────────────┐
         │                    │           │ C2. Preloaded files     │
         │                    │           │     parsed upfront      │
         │                    │           │ (before any operation)  │
         │                    │           └────────────┬────────────┘
         │                    │                        │
         │                    ▼                        │
         │           ┌─────────────────┐               │
         │           │ B1. Session     │               │
         │           │ stores key +    │◄──────────────┘
         │           │ position, not   │  (upfront refresh works
         │           │ copies          │   because navigation reads
         │           └────────┬────────┘   from current table)
         │                    │
         │                    ▼
         │           ┌─────────────────┐
         │           │ B2. Table not   │
         │           │ corrupted by    │
         │           │ project mixing  │
         │           └────────┬────────┘
         │                    │
         ▼                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    SINGLE-PROJECT SERVER POLICY                      │
│         (Server handles one project, client manages switching)       │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ALSO ENABLES                                   │
├─────────────────────────────────────────────────────────────────────┤
│  • .cx becomes startup cache only (not consulted during ops)        │
│  • Include closure sufficient for finding affected files (ADR-13)   │
│  • LSP mode can use same architecture                               │
│  • Simpler mental model for debugging                               │
└─────────────────────────────────────────────────────────────────────┘
----

==== Component Summary

[cols="1,3"]
|===
|Component |Description

|**Single-project server**
|Foundation: Server handles one project at a time. Client (Emacs) manages project switching by restarting server or using separate server instances. Eliminates table corruption from project mixing and enables index-based sessions.

|**Index-based sessions**
|Session stores symbol key + current position instead of copying all references. Navigation reads directly from in-memory table, eliminating the "stale session copies" problem.

|**Upfront preload refresh**
|All preloaded files are parsed at start of each request, before any operation runs. Ensures in-memory table is always current. Requires index-based sessions to work (otherwise session copies would still be stale).

|**Emacs preloads all modified buffers**
|Client-side change: Send `-preload` for all modified buffers, not just current file. Without this, server is blind to modifications in non-current files.

|**No callXref in refactoring**
|Refactoring uses same in-memory table as navigation. Include closure (already implemented) finds affected files; parse on demand. Eliminates the architectural split between navigation and refactoring code paths.
|===

==== Related Decisions and Details

* **ADR-13**: No archaic extern patterns - limits symbol visibility to include-based, making include closure complete
* **ADR-14**: Adopt on-demand parsing architecture - formalizes this direction
* **Chapter 17**: Implementation details for Clean Persistence Store and Unified Symbol Database

==== Current State (January 2025)

The foundation work is **not yet started**. Current workarounds (like excluding refactoring operations from `lastParsedMtime` updates) paper over the architectural tension but don't resolve it.

See link:18-insights.adoc[Chapter 18: Insights] section "The lastParsedMtime Optimization and Refactoring Conflict" for a concrete example of the current complexity.

=== Feature Vision: Full LSP Support

==== The Goal

Enable VS Code, Neovim, and other LSP-capable editors to use c-xrefactory's refactoring and navigation features with full feature parity to the Emacs integration.

==== Current State

* ✓ Go-to-definition for functions, global variables, types (single file only)
* ✓ Files parsed as opened, immediate symbol availability

==== Planned Capabilities

[cols="1,1"]
|===
|Feature |Enables

|**Multi-file navigation**
|Jump to definitions in other files without opening them first

|**Find all references**
|Show all usages of a symbol across the project

|**Hover information**
|Display type and documentation on mouse hover

|**Code completion**
|Context-aware symbol completion

|**Rename refactoring**
|Safe rename across all files

|**Workspace search**
|Find symbols by name across project
|===

==== Dependencies

Full LSP support depends on the "Memory as Truth" architecture:

* Multi-file navigation requires the unified symbol database
* Rename refactoring requires the "no callXref" path
* All features benefit from single-project server simplicity

=== Feature Vision: Modern Refactorings

==== The Goal

Provide refactoring capabilities that understand C semantics, going beyond what generic text-based tools can offer.

==== Current Capabilities

* ✓ Rename (symbols, parameters, macros)
* ✓ Extract function/macro/variable
* ✓ Add/delete/reorder parameters
* ✓ Move function between files (Phase 1 MVP)

==== Planned Improvements

[cols="1,2"]
|===
|Feature |Value

|**Move function Phase 2**
|Automatically add function declaration to target header file

|**Move function Phase 3**
|Detect and optionally move tightly-coupled static helper functions

|**Smart include management**
|Automatically add/remove `#include` directives based on dependencies

|**Refactoring preview**
|Show what will be changed before applying
|===

==== Details

See link:17-major-codebase-improvements.adoc#move-function-refactoring[Chapter 17: Move Function Between Files] for implementation details and phase breakdown.
