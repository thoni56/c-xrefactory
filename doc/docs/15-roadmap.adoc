== Roadmap

This chapter outlines the development roadmap for c-xrefactory, tracking completed work, current priorities, and future architectural goals.

=== Guiding Principles

The roadmap is guided by these principles:

* **Incremental improvement**: Each step should provide immediate value while moving toward long-term goals
* **Test-driven modernization**: Maintain 85%+ test coverage to enable confident refactoring
* **Backward compatibility**: Preserve existing Emacs workflows while enabling modern IDE integration
* **Architectural simplification**: Replace artificial mode distinctions with unified, smart on-demand behavior
* **Legacy code respect**: Work with the existing 1990s codebase thoughtfully, not against it

=== Recent Accomplishments (2025 Q1)

==== C Preprocessor Compliance Fixes

**Problem**: c-xrefactory was incorrectly expanding function-like macros during `pass:[##]` token pasting, violating C99 §6.10.3.3 which mandates that operands of `pass:[##]` should NOT be macro-expanded before concatenation.

**Impact**: Caused SIGSEGV in `test_ffmpeg` when processing complex standard library macros like `INT64_MAX` which expands to `(__INT64_C(9223372036854775807))` where `__INT64_C(c)` is defined as `c pass:[##] L`.

**Fix**: Removed macro expansion logic from `collate()` function in `src/yylex.c:1749-1797`. Now matches GCC behavior exactly.

**Test Updates**: Updated 5 test cases to match correct GCC preprocessor behavior:

* `test_collate_empty`
* `test_token_pasting_with_expansion`
* `test_token_pasting_with_expansion_lhs`
* `test_token_pasting_with_expansion_rhs`
* `test_token_pasting_with_illegal_expansion`

==== Memory Scaling Improvements

**Problem**: Large projects like ffmpeg were hitting the 30MB `stackMemory` limit during symbol table construction.

**Root Cause**: Stack memory is a persistent arena allocator that accumulates symbol tables across all parsed files. Growth is expected and normal for large projects.

**Fix**: Increased `SIZE_stackMemory` from 30MB to 100MB in `src/constants.h:19`.

**Diagnostic Additions**: Added nesting level and stack index tracking in `src/xref.c` to monitor memory usage patterns and detect unbalanced block nesting.

==== Caching System Removal

**Decision**: Removed the complex lexem stream caching mechanism to enable architectural refactoring.

**Impact**: Performance regression for large multi-file parsing (6.4× slowdown on test_ffmpeg/test_systemd), but enables critical modernization work.

**Rationale**: The ~300 lines of cache code were deeply intertwined with parsing and memory management, blocking refactoring efforts. Removal provides clearer code structure at the cost of temporary performance regression.

**See**: link:../adr/0012-remove-lexem-stream-caching.md[ADR-0012: Remove Lexem Stream Caching] for detailed rationale, trade-offs, and future optimization strategies.

=== Short-term Goals

==== Test Coverage Expansion

*Current Status*: **85%+ overall coverage achieved** (January 2025)

*Priority*: MEDIUM (maintenance mode)

*Ongoing Work*:

* Maintain 85%+ overall coverage as new features are added
* Add focused tests for LSP integration points as they're implemented
* Systematic testing of error handling paths in new code
* Monitor coverage regressions during refactoring

==== LSP Integration

*Current Status*: Experimental support for modern editor integration

*Priority*: HIGH - Opens c-xrefactory to wider audience beyond Emacs

*Value*: Enable VS Code, Neovim, and other LSP-capable editors to use c-xrefactory's refactoring and navigation features.

*Current Capabilities*:

* ✓ Go-to-definition for functions, global variables, types (single file)
* ✓ Files parsed as opened, immediate symbol availability

*Key Limitations*:

* Single-file scope only (must open file before navigating to it)
* Local variables not supported
* Only `textDocument/definition` implemented

*Next Steps*: See link:16-planned-features.adoc#lsp-integration[Chapter 16: LSP Integration] for details and link:17-major-codebase-improvements.adoc[Chapter 17] for technical architecture.

==== Documentation Completeness

*Current Status*: Architecture documentation mostly complete

*Priority*: MEDIUM

*Goals*:

* Complete Structurizr C4 model with all major components
* Document memory management strategies across all arenas
* Create user guide for LSP integration
* Document LSP vs Emacs feature parity matrix

=== Medium-term Goals

Focused on internal code quality and architecture improvements that enable future features. Detailed in link:17-major-codebase-improvements.adoc[Chapter 17: Major Codebase Improvements].

==== Code Quality Improvements

**LexemStream API**: Reduce pointer parameter proliferation in macro expansion code (6+ params → 3-4). Foundation for further modularization.

**Macro Module Extraction**: Separate 800 lines of macro expansion logic from `yylex.c` for better testability and maintainability.

**Header Re-parsing Optimization**: Address performance regression from cache removal. Make incremental builds faster.

==== Architectural Improvements

**Clean Persistence Store**: Separate in-memory reference database from disk storage (.cx files). Enables LSP integration and testing without files.

**Unified Symbol Database**: Transition from batch-mode (`-create` required) to on-demand parsing. Enables zero cold-start for LSP.

**Multi-file Support**: Build include graph, enable cross-file navigation. Critical for full LSP feature parity.

=== Long-term Vision

User-facing features and modern IDE capabilities enabled by architectural improvements:

**Additional Refactorings**: Extract expression (not just statements), smart helper function detection, preview dialogs.

**Full LSP Protocol**: Complete `textDocument/references`, hover, completion, rename, document symbols, workspace search.

**Modern IDE Showcase**: VS Code extension, Neovim plugin, performance optimization for large projects.

For technical details on these items, see link:17-major-codebase-improvements.adoc[Chapter 17: Major Codebase Improvements] and link:16-planned-features.adoc[Chapter 16: Planned Features].
