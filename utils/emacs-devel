#!/usr/bin/env bash
#
# Simple Emacs startup using latest development version
#
UTILS="$(dirname "$(realpath "$0")")"

# Load only the main file (c-xrefactory.el) which handles loading dependencies
MAIN_FILE="$UTILS/../editors/emacs/c-xrefactory.el"

# Ensure we don't load compiled stuff
rm -f $UTILS/../editors/emacs/*.elc

# Check if .c-xrefrc exists in the current directory
if [[ -f .c-xrefrc ]]; then
  OPTIONS_FILE="\"$PWD/.c-xrefrc\""
else
  OPTIONS_FILE=""
fi

# Construct Emacs command with proper quoting
# Use -Q to skip loading init file, ensuring a pristine environment
# This verifies c-xrefactory works in a clean setup without user customizations
if [[ -n "$OPTIONS_FILE" ]]; then
  emacs -Q -l "$MAIN_FILE" \
    --eval "(setq c-xref-options-file $OPTIONS_FILE)" \
    --eval "(setq c-xref-exec-directory \"$UTILS/../src/\")" \
    --eval "(setq c-xref-debug-mode t)" \
    --eval "(setq c-xref-debug-preserve-tmp-files t)" \
    --eval "(advice-add 'lsp :override (lambda (&rest args) (message \"LSP disabled for this session\")))" \
    "$@"
else
  emacs -Q -l "$MAIN_FILE" \
    --eval "(setq c-xref-exec-directory \"$UTILS/../src/\")" \
    --eval "(setq c-xref-debug-mode t)" \
    --eval "(setq c-xref-debug-preserve-tmp-files t)" \
    --eval "(advice-add 'lsp :override (lambda (&rest args) (message \"LSP disabled for this session\")))" \
    "$@"
fi
