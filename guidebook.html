<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<meta name="author" content="v{VERSION} - Generated 2025-10-31">
<title>C-xrefactory - a C/Yacc refactoring and code browsing tool - Design Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>C-xrefactory - a C/Yacc refactoring and code browsing tool - Design Documentation</h1>
<div class="details">
<span id="author" class="author">v{VERSION} - Generated 2025-10-31</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_intro">1. Intro</a>
<ul class="sectlevel2">
<li><a href="#_caution">1.1. Caution</a></li>
<li><a href="#_background">1.2. Background</a></li>
<li><a href="#_goal">1.3. Goal</a></li>
</ul>
</li>
<li><a href="#_context">2. Context</a></li>
<li><a href="#_functional_overview">3. Functional Overview</a>
<ul class="sectlevel2">
<li><a href="#_options_option_files_and_configuration">3.1. Options, option files and configuration</a></li>
<li><a href="#_lsp">3.2. LSP</a></li>
</ul>
</li>
<li><a href="#_quality_attributes">4. Quality Attributes</a></li>
<li><a href="#_constraints">5. Constraints</a></li>
<li><a href="#_principles">6. Principles</a>
<ul class="sectlevel2">
<li><a href="#_reference_database_and_parsing">6.1. Reference Database and Parsing</a></li>
<li><a href="#_tbd">6.2. TBD.</a></li>
</ul>
</li>
<li><a href="#_software_architecture">7. Software Architecture</a>
<ul class="sectlevel2">
<li><a href="#_container_view">7.1. Container View</a></li>
<li><a href="#_containers">7.2. Containers</a></li>
</ul>
</li>
<li><a href="#_code">8. Code</a>
<ul class="sectlevel2">
<li><a href="#_commands">8.1. Commands</a></li>
<li><a href="#_passes">8.2. Passes</a></li>
<li><a href="#_parsers">8.3. Parsers</a></li>
<li><a href="#_refactoring_and_the_parsers">8.4. Refactoring and the parsers</a></li>
<li><a href="#_reading_files">8.5. Reading Files</a></li>
<li><a href="#_reference_database">8.6. Reference Database</a></li>
<li><a href="#_editor_plugin">8.7. Editor Plugin</a></li>
<li><a href="#_editor_server">8.8. Editor Server</a></li>
<li><a href="#_refactoring">8.9. Refactoring</a></li>
<li><a href="#_configuration">8.10. Configuration</a></li>
</ul>
</li>
<li><a href="#_modules">9. Modules</a>
<ul class="sectlevel2">
<li><a href="#_yylex">9.1. Yylex</a></li>
<li><a href="#_parser">9.2. Parser</a></li>
<li><a href="#_xref">9.3. Xref</a></li>
<li><a href="#_server">9.4. Server</a></li>
<li><a href="#_refactory">9.5. Refactory</a></li>
<li><a href="#_cxref">9.6. Cxref</a></li>
<li><a href="#_main">9.7. Main</a></li>
<li><a href="#_memory">9.8. Memory</a></li>
<li><a href="#_cxfile_2">9.9. Cxfile</a></li>
<li><a href="#_c_xref_el">9.10. c-xref.el</a></li>
<li><a href="#_c_xrefactory_el">9.11. c-xrefactory.el</a></li>
</ul>
</li>
<li><a href="#_data_structures">10. Data Structures</a>
<ul class="sectlevel2">
<li><a href="#_referenceitems_and_references">10.1. ReferenceItems and References</a></li>
<li><a href="#_symbols_and_references">10.2. Symbols and References</a></li>
<li><a href="#_files_and_buffers">10.3. Files and Buffers</a></li>
<li><a href="#_modes">10.4. Modes</a></li>
<li><a href="#_options_2">10.5. Options</a></li>
</ul>
</li>
<li><a href="#_algorithms">11. Algorithms</a>
<ul class="sectlevel2">
<li><a href="#_how_is_an_extract_refactoring_performed">11.1. How is an Extract refactoring performed?</a></li>
<li><a href="#_how_does">11.2. How does &#8230;&#8203;</a></li>
<li><a href="#_developing_here_be_dragons">11.3. Developing, here be dragons&#8230;&#8203;</a></li>
<li><a href="#_setup">11.4. Setup</a></li>
<li><a href="#_building">11.5. Building</a></li>
<li><a href="#_versions">11.6. Versions</a></li>
<li><a href="#_coding">11.7. Coding</a></li>
<li><a href="#_debugging">11.8. Debugging</a></li>
<li><a href="#_testing">11.9. Testing</a></li>
<li><a href="#_utilities">11.10. Utilities</a></li>
<li><a href="#_debugging_the_protocol">11.11. Debugging the protocol</a></li>
</ul>
</li>
<li><a href="#_deployment">12. Deployment</a></li>
<li><a href="#_decison_log">13. Decison Log</a></li>
<li><a href="#_insights">14. Insights</a>
<ul class="sectlevel2">
<li><a href="#_yacc_semantic_data">14.1. Yacc semantic data</a></li>
</ul>
</li>
<li><a href="#_proposed_refactorings">Proposed Refactorings</a>
<ul class="sectlevel1">
<li><a href="#_lexinput_api_improvements">1. LexInput API Improvements</a>
<ul class="sectlevel2">
<li><a href="#_problem_statement">1.1. Problem Statement</a></li>
<li><a href="#_current_architecture">1.2. Current Architecture</a></li>
<li><a href="#_proposed_solution">1.3. Proposed Solution</a></li>
<li><a href="#_benefits">1.4. Benefits</a></li>
<li><a href="#_implementation_strategy">1.5. Implementation Strategy</a></li>
<li><a href="#_risks_and_mitigation">1.6. Risks and Mitigation</a></li>
<li><a href="#_notes">1.7. Notes</a></li>
<li><a href="#_open_questions">1.8. Open Questions</a></li>
<li><a href="#_references">1.9. References</a></li>
<li><a href="#_related_issues">1.10. Related Issues</a></li>
</ul>
</li>
<li><a href="#unified-symbol-database">2. Unified Symbol Database Architecture</a>
<ul class="sectlevel2">
<li><a href="#_problem_statement_2">2.1. Problem Statement</a></li>
<li><a href="#_current_architecture_limitations">2.2. Current Architecture Limitations</a></li>
<li><a href="#_proposed_solution_2">2.3. Proposed Solution</a></li>
<li><a href="#_implementation_plan">2.4. Implementation Plan</a></li>
<li><a href="#_benefits_2">2.5. Benefits</a></li>
<li><a href="#_existing_infrastructure">2.6. Existing Infrastructure</a></li>
<li><a href="#_open_questions_2">2.7. Open Questions</a></li>
<li><a href="#_references_2">2.8. References</a></li>
</ul>
</li>
<li><a href="#_archive">3. Archive</a>
<ul class="sectlevel2">
<li><a href="#_memory_strategies">3.1. Memory strategies</a></li>
<li><a href="#_trivial_prechecks">3.2. Trivial Prechecks</a></li>
<li><a href="#_huge_memory">3.3. HUGE Memory</a></li>
<li><a href="#_bootstrapping">3.4. Bootstrapping</a></li>
<li><a href="#_fill_macros">3.5. FILL macros</a></li>
<li><a href="#_caching_module">3.6. Caching Module</a></li>
<li><a href="#_caching_system_architecture">3.7. Caching System Architecture</a></li>
<li><a href="#_users">3.8. Users</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This document is very much a work in progress.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_intro">1. Intro</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>c-xrefactory</code> is a software tool and a project aiming at restoring
the sources of that old, but very useful, tool to a state where it can
be enhanced and be the foundation for a highly capable refactoring
browser.</p>
</div>
<div class="paragraph">
<p>It <em>is</em> currently in working condition, so you can use it. For
information about that, see the
<a href="https://github.com/thoni56/c-xrefactory/blob/main/README.md">README.md</a>.</p>
</div>
<div class="sect2">
<h3 id="_caution">1.1. Caution</h3>
<div class="paragraph">
<p>As indicated by the
<a href="https://github.com/thoni56/c-xrefactory/blob/main/README.md">README.md</a>,
this is a long term restoration project. So anything you find in this
document might be old, incorrect, guesses, temporary holders for
thoughts or theories. Or actually true and useful.</p>
</div>
<div class="paragraph">
<p>Especially names of variables, functions and modules is prone to
change as understanding of them increases. They might also be
refactored into something entirently different.</p>
</div>
<div class="paragraph">
<p>As this point this document is just a collection of unstructured
thougths, guesses, historic anecdotes and ideas. For example, the
previously existing, and also unstructured, wiki pages have just been
pasted in here in an attempt to collect everything in a single
document. Perhaps that will make it possible to "refactor" the
information into something actually useful.</p>
</div>
<div class="paragraph">
<p>The last part of this document is an Archive where completely obsolete
descriptions have been moved for future software archeologists to
find.</p>
</div>
</div>
<div class="sect2">
<h3 id="_background">1.2. Background</h3>
<div class="paragraph">
<p>You will find some background about the project in the
<a href="https://github.com/thoni56/c-xrefactory/blob/main/README.md">README.md</a>.</p>
</div>
<div class="paragraph">
<p>This document tries to collect the knowledge and understanding about
how <code>c-xrefactory</code> actually works, plans for making it better, both in
terms of working with the source, its structure and its features.</p>
</div>
<div class="paragraph">
<p>Hopefully over time this will be the design documentation of
<code>c-xrefactory</code>, which, at that time, will be a fairly well structured
and useful piece of software.</p>
</div>
</div>
<div class="sect2">
<h3 id="_goal">1.3. Goal</h3>
<div class="paragraph">
<p>Ultimately <code>c-xrefactory</code> could become <em>the</em> refactoring browser for
C, the one that everybody uses. As suggested by @tajmone in GitHub
issue #39, by switching to a general protocol, we could possibly plug
this in to many editors.</p>
</div>
<div class="paragraph">
<p>However, to do that we need to refactor out the protocol parts. And to
do that we need a better structure, and to dare to change that, we
need to understand more of the intricacies of this beast, and we need
tests. So the normal legacy code catch 22 applies&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Test coverage is starting to look good, coming up to about 80% at the
time of writing this. But that is mostly "application level"
execution, rather than actual tests.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_context">2. Context</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>c-xrefactory</code> is designed to be an aid for programmers as they write,
edit, inspect, read and improve the code they are working on.</p>
</div>
<div class="paragraph">
<p>The editor is used for usual manual manipulation of the source
code. <code>C-xrefactory</code> interacts with the editor to provide navigation
and automated edits, refactorings, through the editor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
@startuml
title &lt;size:24&gt;System Context View: C-xrefactory&lt;/size&gt;

set separator none
left to right direction
skinparam ranksep 60
skinparam nodesep 30
hide stereotype

&lt;style&gt;
  root {
    BackgroundColor: #ffffff;
    FontColor: #444444;
  }
  // Element,DB
  .Element-RWxlbWVudCxEQg== {
    BackgroundColor: #ffffff;
    LineColor: #444444;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #444444;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Person,Ext
  .Element-RWxlbWVudCxQZXJzb24sRXh0 {
    BackgroundColor: #686868;
    LineColor: #484848;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Software System
  .Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0= {
    BackgroundColor: #1168bd;
    LineColor: #0b4884;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Software System,Editor,Ext
  .Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA== {
    BackgroundColor: #686868;
    LineColor: #484848;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Relationship
  .Relationship-UmVsYXRpb25zaGlw {
    LineThickness: 2;
    LineStyle: 10-10;
    LineColor: #444444;
    FontColor: #444444;
    FontSize: 24;
  }
&lt;/style&gt;

person "==Developer\n&lt;size:16&gt;[Person]&lt;/size&gt;\n\nEdits source code using an editor" &lt;&lt;Element-RWxlbWVudCxQZXJzb24sRXh0&gt;&gt; as Developer
rectangle "==Editor\n&lt;size:16&gt;[Software System]&lt;/size&gt;\n\nAllows Developer to modify source code and perform refactoring operations" &lt;&lt;Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA==&gt;&gt; as Editor
database "==Source Code\n&lt;size:16&gt;[a set of files stored on disk]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxEQg==&gt;&gt; as 3
rectangle "==C-xrefactory\n&lt;size:16&gt;[Software System]&lt;/size&gt;\n\nAnalyses source code, receives and processes requests for navigation and refactoring" &lt;&lt;Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0=&gt;&gt; as Cxrefactory

Editor --&gt; Cxrefactory &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "extends functionality using\n&lt;size:16&gt;[plugin]&lt;/size&gt;"
Cxrefactory --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "reads source code from\n&lt;size:16&gt;[file I/O]&lt;/size&gt;"
Developer --&gt; Editor &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "usual editor/IDE operations"
Developer --&gt; Cxrefactory &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "configuration and command line invocations"
Editor --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "normal editing operations"
Editor --&gt; Cxrefactory &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "navigation and refactoring requests"
Cxrefactory --&gt; Editor &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "positioning and editing responses"
Cxrefactory --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "read/analyze"

@enduml</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_overview">3. Functional Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>c-xref</em> program is actually a mish-mash of a multitude of
features baked into one program. This is the major cause of the mess
that it is source-wise.</p>
</div>
<div class="paragraph">
<p>It was</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a generator for persistent cross-reference data</p>
</li>
<li>
<p>a reference server for editors, serving cross-reference, navigational and completion data over a protocol</p>
</li>
<li>
<p>a refactoring server (the worlds first to cross the Refactoring Rubicon)</p>
</li>
<li>
<p><span class="line-through">an HTML cross-reference generator (probably the root of the project)</span> (REMOVED)</p>
</li>
<li>
<p><span class="line-through">a C macro generator for structure fill (and other) functions</span> (REMOVED)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is the first three that are unique and constitutes the great value
of this project. The last two have been removed from the source, the
last one because it was a hack and prevented modern, tidy, building,
coding and refactoring. The HTML cross-reference generator has been
superseeded by modern alternatives like Doxygen and is not at the core
of the goal of this project.</p>
</div>
<div class="paragraph">
<p>One might surmise that it was the HTML-crossreference generator that
was the initial purpose of what the original <code>Xrefactory</code> was based
upon. Once that was in place the other followed, and were basically
only bolted on top without much re-architecting the C sources.</p>
</div>
<div class="paragraph">
<p>What we&#8217;d like to do is partition the project into separate parts,
each having a clear usage.</p>
</div>
<div class="paragraph">
<p>The following sections are aimed at describing various features of
<code>c-xrefactory</code>.</p>
</div>
<div class="sect2">
<h3 id="_options_option_files_and_configuration">3.1. Options, option files and configuration</h3>
<div class="paragraph">
<p>The current version of C-xrefactory allows only two possible sets of
configuration/options.</p>
</div>
<div class="paragraph">
<p>The primary storage is (currently) the file <code>$HOME/.c-xrefrc</code>
which stores the "standard" options for all projects. Each project has
a separate section which is started with a section marker, the project
name surrounded by square brackets, <code>[project1]</code>.</p>
</div>
<div class="paragraph">
<p>When you start <code>c-xref</code> you can use the command line option <code>-xrefrc</code>
to request that a particular option file should be used instead of the
"standard options".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When running the edit server there seems to be no way to
indicate a different options files for different
projects/files. Although you can start the server with <code>-xrefrc</code> you
will be stuck with that in the whole session and for all projects.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_lsp">3.2. LSP</h3>
<div class="paragraph">
<p>The LSP protocol is a common protocol for language servers such as
<code>clangd</code> and <code>c-xrefactory</code>. It allows an editor (client) to interface
to a server to request information, such as reference positions, and
operations, such as refactorings, without knowing exactly which server
it talks to.</p>
</div>
<div class="paragraph">
<p>Recent versions of <code>c-xrefactory</code> have an initial implementation of a
very small portion of the LSP protocol. The plan is to fully integrate
the functionality of <code>c-xrefactory</code> into the LSP protocol. This will
allow use of <code>c-xrefactory</code> from not only Emacs but also Visual Studio
Code or any other editor that supports the LSP protocol.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quality_attributes">4. Quality Attributes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most important quality attributes are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>correctness - a refactoring should never alter the behaviour of the refactored code</p>
</li>
<li>
<p>completness - no reference to a symbol should ever be missed</p>
</li>
<li>
<p>performance - a refactoring should be sufficiently quick so the user keeps focus on the task at hand</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_constraints">5. Constraints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TBD.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_principles">6. Principles</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_reference_database_and_parsing">6.1. Reference Database and Parsing</h3>
<div class="paragraph">
<p>The reference database is used only to hold externally visible
identifiers to ensure that references to an identifier can be found
across all files in the used source.</p>
</div>
<div class="paragraph">
<p>All symbols that are only visible inside a unit is handled by
reparsing the file of interest.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tbd">6.2. TBD.</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_software_architecture">7. Software Architecture</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_container_view">7.1. Container View</h3>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
@startuml
title &lt;size:24&gt;Container View: C-xrefactory&lt;/size&gt;

set separator none
left to right direction
skinparam ranksep 60
skinparam nodesep 30
hide stereotype

&lt;style&gt;
  root {
    BackgroundColor: #ffffff;
    FontColor: #444444;
  }
  // Element,Container
  .Element-RWxlbWVudCxDb250YWluZXI= {
    BackgroundColor: #438dd5;
    LineColor: #2e6295;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Container,DB
  .Element-RWxlbWVudCxDb250YWluZXIsREI= {
    BackgroundColor: #438dd5;
    LineColor: #2e6295;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,DB
  .Element-RWxlbWVudCxEQg== {
    BackgroundColor: #ffffff;
    LineColor: #444444;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #444444;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Person,Ext
  .Element-RWxlbWVudCxQZXJzb24sRXh0 {
    BackgroundColor: #686868;
    LineColor: #484848;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Software System,Editor,Ext
  .Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA== {
    BackgroundColor: #686868;
    LineColor: #484848;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Relationship
  .Relationship-UmVsYXRpb25zaGlw {
    LineThickness: 2;
    LineStyle: 10-10;
    LineColor: #444444;
    FontColor: #444444;
    FontSize: 24;
  }
  // C-xrefactory
  .Boundary-Qy14cmVmYWN0b3J5 {
    BackgroundColor: #ffffff;
    LineColor: #0b4884;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
  }
&lt;/style&gt;

person "==Developer\n&lt;size:16&gt;[Person]&lt;/size&gt;\n\nEdits source code using an editor" &lt;&lt;Element-RWxlbWVudCxQZXJzb24sRXh0&gt;&gt; as Developer
rectangle "==Editor\n&lt;size:16&gt;[Software System]&lt;/size&gt;\n\nAllows Developer to modify source code and perform refactoring operations" &lt;&lt;Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA==&gt;&gt; as Editor
database "==Source Code\n&lt;size:16&gt;[a set of files stored on disk]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxEQg==&gt;&gt; as 3

rectangle "C-xrefactory\n&lt;size:16&gt;[Software System]&lt;/size&gt;" &lt;&lt;Boundary-Qy14cmVmYWN0b3J5&gt;&gt; {
  rectangle "==cxrefCore\n&lt;size:16&gt;[Container: Refactoring Browser core]&lt;/size&gt;\n\nC Language program" &lt;&lt;Element-RWxlbWVudCxDb250YWluZXI=&gt;&gt; as Cxrefactory.cxrefCore
  database "==settingsStore\n&lt;size:16&gt;[Container: Configuration file for project settings]&lt;/size&gt;\n\nNon-standard format settings file" &lt;&lt;Element-RWxlbWVudCxDb250YWluZXIsREI=&gt;&gt; as Cxrefactory.settingsStore
  rectangle "==editorExtension\n&lt;size:16&gt;[Container: Plugin]&lt;/size&gt;\n\nExtends the Editor with c-xref operations and interfaces to the c-xrefactory API" &lt;&lt;Element-RWxlbWVudCxDb250YWluZXI=&gt;&gt; as Cxrefactory.editorExtension
  database "==referencesDb\n&lt;size:16&gt;[Container: Persistent symbol database storing references, definitions, and metadata for all project symbols. Created via -create/-update operations, indexed by symbol hash for fast lookup]&lt;/size&gt;\n\nCross-Reference Database (.cx files)" &lt;&lt;Element-RWxlbWVudCxDb250YWluZXIsREI=&gt;&gt; as Cxrefactory.referencesDb
}

Editor --&gt; Cxrefactory.editorExtension &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "extends functionality using\n&lt;size:16&gt;[plugin]&lt;/size&gt;"
Cxrefactory.cxrefCore --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "reads source code from\n&lt;size:16&gt;[file I/O]&lt;/size&gt;"
Cxrefactory.cxrefCore --&gt; Cxrefactory.referencesDb &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "builds and queries\n&lt;size:16&gt;[hash-based lookup]&lt;/size&gt;"
Cxrefactory.editorExtension --&gt; Cxrefactory.settingsStore &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "writes\n&lt;size:16&gt;[new project wizard]&lt;/size&gt;"
Cxrefactory.cxrefCore --&gt; Cxrefactory.settingsStore &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "read"
Cxrefactory.editorExtension --&gt; Cxrefactory.cxrefCore &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "API\n&lt;size:16&gt;[requests information and gets commands to modify source code]&lt;/size&gt;"
Cxrefactory.cxrefCore --&gt; Cxrefactory.referencesDb &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "read/write"
Cxrefactory.cxrefCore --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "read/analyze"
Developer --&gt; Editor &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "usual editor/IDE operations"
Editor --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "normal editing operations"
Editor --&gt; Cxrefactory.editorExtension &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "extends\n&lt;size:16&gt;[Editor extension protocol]&lt;/size&gt;"
Developer --&gt; Cxrefactory.settingsStore &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "edit"
Cxrefactory.editorExtension --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "extended c-xrefactory operations"

@enduml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_containers">7.2. Containers</h3>
<div class="paragraph">
<p>At this point the description of the internal structure of the containers are
tentative. The actual interfaces are not particularly clean, most code
files can and do include much every other module.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One focus area for the ongoing work is to try to pry out modules/components
from the code mess by moving functions around, renaming and hiding
functions, where possible.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_cxrefcore">7.2.1. CxrefCore</h4>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
@startuml
title &lt;size:24&gt;Component View: C-xrefactory - cxrefCore&lt;/size&gt;

set separator none
left to right direction
skinparam ranksep 60
skinparam nodesep 30
hide stereotype

&lt;style&gt;
  root {
    BackgroundColor: #ffffff;
    FontColor: #444444;
  }
  // Element,Component
  .Element-RWxlbWVudCxDb21wb25lbnQ= {
    BackgroundColor: #85bbf0;
    LineColor: #5d82a8;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #000000;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Container,DB
  .Element-RWxlbWVudCxDb250YWluZXIsREI= {
    BackgroundColor: #438dd5;
    LineColor: #2e6295;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,DB
  .Element-RWxlbWVudCxEQg== {
    BackgroundColor: #ffffff;
    LineColor: #444444;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #444444;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Relationship
  .Relationship-UmVsYXRpb25zaGlw {
    LineThickness: 2;
    LineStyle: 10-10;
    LineColor: #444444;
    FontColor: #444444;
    FontSize: 24;
  }
  // C-xrefactory
  .Boundary-Qy14cmVmYWN0b3J5 {
    BackgroundColor: #ffffff;
    LineColor: #0b4884;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
  }
  // cxrefCore
  .Boundary-Y3hyZWZDb3Jl {
    BackgroundColor: #ffffff;
    LineColor: #2e6295;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
  }
&lt;/style&gt;

database "==Source Code\n&lt;size:16&gt;[a set of files stored on disk]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxEQg==&gt;&gt; as 3

rectangle "C-xrefactory\n&lt;size:16&gt;[Software System]&lt;/size&gt;" &lt;&lt;Boundary-Qy14cmVmYWN0b3J5&gt;&gt; {
  rectangle "cxrefCore\n&lt;size:16&gt;[Container: Refactoring Browser core]&lt;/size&gt;" &lt;&lt;Boundary-Y3hyZWZDb3Jl&gt;&gt; {
    rectangle "==main\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nMain program" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.main
    rectangle "==xref\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nCross-referencer" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.xref
    rectangle "==server\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nEditor Server" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.server
    rectangle "==refactory\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nRefactory" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.refactory
    rectangle "==lsp\n&lt;size:16&gt;[Component: Language Server Protocol implementation for IDE integration - currently limited by symbol database architecture]&lt;/size&gt;\n\nLSP Server" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.lsp
    rectangle "==lspAdapter\n&lt;size:16&gt;[Component: Converts LSP requests to c-xrefactory operations - needs symbol database abstraction]&lt;/size&gt;\n\nLSP Adapter" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.lspAdapter
    rectangle "==cxref\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nReference handler" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.cxref
    rectangle "==cxfile\n&lt;size:16&gt;[Component: Manages persistent cross-reference database with symbol indexing and file-based storage]&lt;/size&gt;\n\nReference Storage (.cx files)" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.cxfile
    rectangle "==browserStack\n&lt;size:16&gt;[Component: Runtime symbol context stack for navigation, containing current references and symbol menus]&lt;/size&gt;\n\nBrowser Stack" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.browserStack
    rectangle "==symbolResolver\n&lt;size:16&gt;[Component: Converts cursor positions to symbols, loads references, and finds definitions]&lt;/size&gt;\n\nSymbol Resolution Pipeline" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.symbolResolver
    rectangle "==referenceTable\n&lt;size:16&gt;[Component: Runtime symbol cache loaded from .cx files for active session]&lt;/size&gt;\n\nIn-Memory Reference Table" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.referenceTable
    rectangle "==yylex\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nLexical Analyser" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.yylex
    rectangle "==parser\n&lt;size:16&gt;[Component: C]&lt;/size&gt;\n\nParser" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.cxrefCore.parser
  }

  database "==referencesDb\n&lt;size:16&gt;[Container: Persistent symbol database storing references, definitions, and metadata for all project symbols. Created via -create/-update operations, indexed by symbol hash for fast lookup]&lt;/size&gt;\n\nCross-Reference Database (.cx files)" &lt;&lt;Element-RWxlbWVudCxDb250YWluZXIsREI=&gt;&gt; as Cxrefactory.referencesDb
}

Cxrefactory.cxrefCore.main --&gt; Cxrefactory.cxrefCore.xref &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "dispatches to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.main --&gt; Cxrefactory.cxrefCore.server &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "dispatches to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.main --&gt; Cxrefactory.cxrefCore.refactory &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "dispatches to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.main --&gt; Cxrefactory.cxrefCore.lsp &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "dispatches to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.refactory --&gt; Cxrefactory.cxrefCore.server &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "uses\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.cxref --&gt; Cxrefactory.cxrefCore.symbolResolver &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "delegates symbol lookup to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.symbolResolver --&gt; Cxrefactory.cxrefCore.cxfile &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "loads symbol data via\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.symbolResolver --&gt; Cxrefactory.cxrefCore.referenceTable &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "populates and queries\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.symbolResolver --&gt; Cxrefactory.cxrefCore.browserStack &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "builds navigation context in\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.cxfile --&gt; Cxrefactory.cxrefCore.referenceTable &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "loads symbols into\n&lt;size:16&gt;[batch loading]&lt;/size&gt;"
Cxrefactory.cxrefCore.lsp --&gt; Cxrefactory.cxrefCore.lspAdapter &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "delegates to\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.lspAdapter --&gt; Cxrefactory.cxrefCore.refactory &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "uses for refactoring\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.lspAdapter --&gt; Cxrefactory.cxrefCore.cxref &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "uses for navigation\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.lspAdapter --&gt; Cxrefactory.cxrefCore.symbolResolver &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "attempts symbol lookup via\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.xref --&gt; Cxrefactory.cxrefCore.cxref &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "handles references using\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.server --&gt; Cxrefactory.cxrefCore.cxref &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "handles references using\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.refactory --&gt; Cxrefactory.cxrefCore.cxref &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "handles references using\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.parser --&gt; Cxrefactory.cxrefCore.yylex &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "reads tokenized source using\n&lt;size:16&gt;[buffering]&lt;/size&gt;"
Cxrefactory.cxrefCore.xref --&gt; Cxrefactory.cxrefCore.parser &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "parses source code using\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.server --&gt; Cxrefactory.cxrefCore.parser &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "parses source code using\n&lt;size:16&gt;[call]&lt;/size&gt;"
Cxrefactory.cxrefCore.yylex --&gt; 3 &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "reads source code from\n&lt;size:16&gt;[file I/O]&lt;/size&gt;"
Cxrefactory.cxrefCore.cxfile --&gt; Cxrefactory.referencesDb &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "builds and queries\n&lt;size:16&gt;[hash-based lookup]&lt;/size&gt;"

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p><code>cxrefCore</code> is the core container. It does all the work when it comes
to finding and reporting references to symbols, communicating
refactoring requests as well as storing reference information for
longer term storage and caching.</p>
</div>
<div class="paragraph">
<p>Although <code>c-xref</code> can be used as a command line tool, which can be
handy when debugging or exploring, it is normally used in "server"
mode. In server mode the communication between the editor extension
and the cxrefCore container is a back-and-forth communication using a
non-standard protocol over standard pipes.</p>
</div>
<div class="paragraph">
<p>The responsibilities of <code>cxrefCore</code> can largely be divided into</p>
</div>
<div class="ulist">
<ul>
<li>
<p>parsing source files to create, maintain the references database which stores all inter-module references</p>
</li>
<li>
<p>parsing source files to get important information such as positions for a functions begin and end</p>
</li>
<li>
<p>managing editor buffer state (as it might differ from the file on disc)</p>
</li>
<li>
<p>performing symbol navigation</p>
</li>
<li>
<p>creating and serving completion suggestions</p>
</li>
<li>
<p>performing refactorings such as renames, extracts and parameter manipulation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this point it seems like refactorings are performed as separate
invocations of <code>c-xref</code> rather than through the server interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_editorextension">7.2.2. EditorExtension</h4>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
@startuml
title &lt;size:24&gt;Component View: C-xrefactory - editorExtension&lt;/size&gt;

set separator none
left to right direction
skinparam ranksep 60
skinparam nodesep 30
hide stereotype

&lt;style&gt;
  root {
    BackgroundColor: #ffffff;
    FontColor: #444444;
  }
  // Element,Component
  .Element-RWxlbWVudCxDb21wb25lbnQ= {
    BackgroundColor: #85bbf0;
    LineColor: #5d82a8;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #000000;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Element,Software System,Editor,Ext
  .Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA== {
    BackgroundColor: #686868;
    LineColor: #484848;
    LineStyle: 0;
    LineThickness: 2;
    RoundCorner: 20;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
    MaximumWidth: 450;
  }
  // Relationship
  .Relationship-UmVsYXRpb25zaGlw {
    LineThickness: 2;
    LineStyle: 10-10;
    LineColor: #444444;
    FontColor: #444444;
    FontSize: 24;
  }
  // C-xrefactory
  .Boundary-Qy14cmVmYWN0b3J5 {
    BackgroundColor: #ffffff;
    LineColor: #0b4884;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
  }
  // editorExtension
  .Boundary-ZWRpdG9yRXh0ZW5zaW9u {
    BackgroundColor: #ffffff;
    LineColor: #2e6295;
    LineStyle: 0;
    LineThickness: 2;
    FontColor: #ffffff;
    FontSize: 24;
    HorizontalAlignment: center;
    Shadowing: 0;
  }
&lt;/style&gt;

rectangle "==Editor\n&lt;size:16&gt;[Software System]&lt;/size&gt;\n\nAllows Developer to modify source code and perform refactoring operations" &lt;&lt;Element-RWxlbWVudCxTb2Z0d2FyZSBTeXN0ZW0sRWRpdG9yLEV4dA==&gt;&gt; as Editor

rectangle "C-xrefactory\n&lt;size:16&gt;[Software System]&lt;/size&gt;" &lt;&lt;Boundary-Qy14cmVmYWN0b3J5&gt;&gt; {
  rectangle "editorExtension\n&lt;size:16&gt;[Container: Plugin]&lt;/size&gt;" &lt;&lt;Boundary-ZWRpdG9yRXh0ZW5zaW9u&gt;&gt; {
    rectangle "==cxref.el\n&lt;size:16&gt;[Component: elisp]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.editorExtension.cxrefel
    rectangle "==cxrefactory.el\n&lt;size:16&gt;[Component: elisp]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.editorExtension.cxrefactoryel
    rectangle "==cxrefprotocol.el\n&lt;size:16&gt;[Component: elisp]&lt;/size&gt;" &lt;&lt;Element-RWxlbWVudCxDb21wb25lbnQ=&gt;&gt; as Cxrefactory.editorExtension.cxrefprotocolel
  }

}

Editor --&gt; Cxrefactory.editorExtension.cxrefactoryel &lt;&lt;Relationship-UmVsYXRpb25zaGlw&gt;&gt; : "extends functionality using\n&lt;size:16&gt;[plugin]&lt;/size&gt;"

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>EditorExtension</code> container is responsible for plugging into an
editor of choice and handle the user interface, buffer management and
executing the refactoring edit operations.</p>
</div>
<div class="paragraph">
<p>Currently there is only one such extension supported, for <code>Emacs</code>,
although there existed code, still available in the repo history, for
an extension for <code>jEdit</code> which hasn&#8217;t been updated, modified or checked
for a long time and no longer is a part of this project.</p>
</div>
</div>
<div class="sect3">
<h4 id="_referencesdb">7.2.3. ReferencesDB</h4>
<div class="paragraph">
<p>The References database stores crossreferencing information for
symbols visible outside the module it is defined in. Information about
local/static symbols are not stored but gathered by parsing that
particular source file on demand.</p>
</div>
<div class="paragraph">
<p>Currently this information is stored in a somewhat cryptic, optimized
text format.</p>
</div>
<div class="paragraph">
<p>This storage can be divided into multiple files, probably for faster
access. Symbols are then hashed to know which of the "database" files
it is stored in. As all crossreferencing information for a symbol is
stored in the same "record", this allows reading only a single file
when a symbol is looked up.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code">8. Code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_commands">8.1. Commands</h3>
<div class="paragraph">
<p>The <em>editorExtension</em> calls the server using command line
options. These are then converted to first a command enum starting in
<code>OLO</code> ("on-line operation") or <code>AVR</code> ("available refactoring").</p>
</div>
<div class="paragraph">
<p>Some times the server needs to call the crossreferencer which is
performed in the same manner, command line options, but this call is
internal so the wanted arguments are stored in a vector which is
passed to the <code>xref()</code> in the same manner as <code>main()</code> passes the
actual <code>argc</code>/<code>argv</code>.</p>
</div>
<div class="paragraph">
<p>Many of the commands require extra arguments like positions/markers
which are passed in as extra arguments. E.g. a rename requires the
name to rename to which is sent in the <code>renameto=</code> option, which is
argparsed and stored in the option structure.</p>
</div>
<div class="paragraph">
<p>Some of these extra arguments are fairly random, like <code>-olcxparnum=</code>
and <code>-olcxparnum2=</code>. This should be cleaned up.</p>
</div>
<div class="paragraph">
<p>A move towards "events" with arguments would be helpful. This would
mean that we need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List all "events" that <code>c-xref</code> need to handle</p>
</li>
<li>
<p>Define the parameters/extra info that each of them need</p>
</li>
<li>
<p>Clean up the command line options to follow this</p>
</li>
<li>
<p>Create event structures to match each event and pass this to <code>server</code>, <code>xref</code> and <code>refactory</code></p>
</li>
<li>
<p>Rebuild the main command loop to parse command line options into event structures</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_passes">8.2. Passes</h3>
<div class="paragraph">
<p>There is a variable in <code>main()</code> called <code>firstPassing</code> which is set and passed
down through <code>mainEditServer()</code> until it is reset in
<code>mainFileProcessingInitialisations()</code>.</p>
</div>
<div class="paragraph">
<p>This is probably related to the fact that <code>c-xref</code> allows for passing
over the analyzed source multiple passes in case you compile the
project sources with different C defines. Variables in the <code>c-xref</code>
sources indicate this, e.g the loops in <code>mainEditServerProcessFile()</code>
and <code>mainXrefProcessInputFile()</code> (which are both strangely limited by
setting the maxPass variable to 1 before entering the loop&#8230;&#8203;).</p>
</div>
</div>
<div class="sect2">
<h3 id="_parsers">8.3. Parsers</h3>
<div class="paragraph">
<p><em>C-xref</em> uses a patched version of Berkley yacc to generate
parsers. There are a number of parsers</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C</p>
</li>
<li>
<p>Yacc</p>
</li>
<li>
<p>C expressions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There might also exist small traces of the Java parser, which was
previously a part of the free <code>c-xref</code>, and the C++ parser that
existed but was proprietary.</p>
</div>
<div class="paragraph">
<p>The patch to byacc is mainly to the skeleton and seems to relate
mostly to handling of errors and adding a recursive parsing feature
that is required for Java, which was supported previously. It is not
impossible that this patch might not be necessary now that Java parsing
is not necessary, but this has not been tried.</p>
</div>
<div class="paragraph">
<p>Some changes are also made to be able to accomodate multiple parsers
in the same executable, mostly solved by CPP macros renaming the
parsing datastructures so that they can be accessed using the standard
names in the parsing skeleton. The Makefile generates the parsers and
renames the generated files as appropriate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_and_the_parsers">8.4. Refactoring and the parsers</h3>
<div class="paragraph">
<p>Some refactorings need more detailed information about the code, maybe all do?</p>
</div>
<div class="paragraph">
<p>One example, at least, is parameter manipulation.  Then the refactorer
calls the appropriate parser (<code>serverEditParseBuffer()</code>) which
collects information in the corresponding semantic actions.  This
information is stored in various global variables, like
<code>parameterBeginPosition</code>.</p>
</div>
<div class="paragraph">
<p>The parser is filling out a ParsedInfo structure which conveys
information that can be used e.g. when extracting functions etc.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this point I don&#8217;t understand exactly how this interaction is
performed, there seems to be no way to parse only appropriate parts,
so the whole file need to be re-parsed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Findings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>some global variables are set as a result of command line
and arguments parsing, depending on which "command" the server is
acting on</p>
</li>
<li>
<p>the semantic rules in the parser(s) contains code that matches these
global variables and then inserts special lexems in the lexem stream</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One example is how a Java 'move static method' was performed. It
requires a target position. That position is transferred from command
line options to global variables. When the Java parser was parsing a
class or similar it (or rather the lexer) looks at that "ddtarget
position information" and inserts a <code>OL_MARKER_TOKEN</code> in the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TODO: What extra "operation" the parsing should perform and return
data for should be packaged into some type of "command" or parameter
object that should be passed to the parser, rather than relying on
global variables.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_reading_files">8.5. Reading Files</h3>
<div class="paragraph">
<p>Here are some speculations about how the complex file reading is structured.</p>
</div>
<div class="paragraph">
<p>Each file is identified by a filenumber, which is an index into the
file table, and seems to have a <code>lexBuffer</code> tied to it so that you can
just continue from where ever you were. That in turn contains a
<code>CharacterBuffer</code> that handles the actual character reading.</p>
</div>
<div class="paragraph">
<p>And there is also an "editorBuffer"&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The intricate interactions between these are hard to follow as the code
here are littered with short character names which are copies of fields
in the structures, and infested with many macros, probably in an ignorant
attempt at optimizing. ("The root of all evil is premature optimization" and
"Make it work, make it right, make it fast".)</p>
</div>
<div class="paragraph">
<p>It seems that everything start in <code>initInput()</code> in <code>yylex.c</code> where the
only existing call to <code>fillFileDescriptor()</code> is made. But you might
wonder why this function does some initial reading, this should be
pushed down to the buffers in the file descriptor.</p>
</div>
<div class="sect3">
<h4 id="_lexingscanning">8.5.1. Lexing/scanning</h4>
<div class="paragraph">
<p>Lexing/scanning is performed in two layers, one in <code>lexer.c</code> which
seems to be doing the actual lexing into lexems which are put in a
lexembuffer. This contains a sequence of encoded and compressed
symbols which first has a <code>LexemCode</code> which is followed by extra data,
like <code>Position</code>. These seems to always be added but not always necessary.</p>
</div>
<div class="paragraph">
<p>The higher level "scanning" is performed, as per ususal,
by <code>yylex.c</code>. <code>lexembuffer</code> defines some functions to put and get
lexems, chars (identifiers and file names?) as well as integers and
positions.</p>
</div>
<div class="paragraph">
<p>At this point the put/get lexem functions take a pointer to a pointer
to chars (which presumably is the lexem stream in the lexembuffer)
which it also advances. This requires the caller to manage the
LexemBuffer&#8217;s internal pointers outside and finally set them right
when done.</p>
</div>
<div class="paragraph">
<p>It would be much better to call the "putLexem()"-functions with a
lexemBuffer but there seems to be a few cases where the destination
(often <code>dd</code>) is not a lexem stream inside a lexemBuffer. These might
be related to macro handling.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a work-in-progress.  Currently most of the "normal"
usages are prepared to use the LexemBuffer&#8217;s pointers.  But the
handling of macros and defines are cases where the lexems are not put
in a LexemBuffer.  See the TODO.org for current status of this Mikado
sequence.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_semantic_information">8.5.2. Semantic information</h4>
<div class="paragraph">
<p>As the refactoring functions need some amount of semantic information,
in the sense of information gathered during parsing, this information
is collected in various ways when <code>c-xref</code> calls the "sub-task" to do
the parsing required.</p>
</div>
<div class="paragraph">
<p>Two structures hold information about various things, among which are
the memory index at certain points of the parsing. Thus it is possible
to verify e.g. that a editor region does not cover a break in block or
function structure. This structure is, at the point of writing, called
<code>parsedInfo</code> and definitely need to be tidied up.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reference_database">8.6. Reference Database</h3>
<div class="paragraph">
<p><code>c-xref</code> run in "xref" mode creates, or updates, a database of
references for all externally visible symbols it encounters.</p>
</div>
<div class="paragraph">
<p>A good design should have a clean and generic interface to the
reference database, but this is still a work in progress to chisel
this out.</p>
</div>
<div class="sect3">
<h4 id="_architecture_overview">8.6.1. Architecture Overview</h4>
<div class="paragraph">
<p>c-xrefactory&#8217;s core functionality relies on a sophisticated symbol database that stores cross-references, definitions, and usage information for all symbols in a project. The database is implemented as a collection of binary <code>.cx</code> files and supports:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Creation</strong> via <code>-create</code> operations that parse all project files</p>
</li>
<li>
<p><strong>Updates</strong> via <code>-update</code> operations (incremental or full)</p>
</li>
<li>
<p><strong>Queries</strong> during symbol lookup operations</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_database_structure_and_format">8.6.2. Database Structure and Format</h4>
<div class="paragraph">
<p>The symbol database uses a hash-partitioned file structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cxrefs/
 files        # File metadata and paths
 0000         # Symbol data for hash bucket 0
 0001         # Symbol data for hash bucket 1
 ...          # Additional hash buckets based on referenceFileCount</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>.cx</code> file contains structured records with specific keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CXFI_FILE_NAME</code>: File paths and metadata</p>
</li>
<li>
<p><code>CXFI_SYMBOL_NAME</code>: Symbol names, types, and attributes</p>
</li>
<li>
<p><code>CXFI_REFERENCE</code>: Individual symbol references with positions and usage types</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_symbol_resolution_pipeline">8.6.3. Symbol Resolution Pipeline</h4>
<div class="paragraph">
<p>The symbol lookup process follows this pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1. Cursor Position Input
   
2. Parse current file to identify symbol at position
   
3. scanReferencesToCreateMenu(symbolName)
   
4. Load symbol data from .cx files
   
5. Populate sessionData.browserStack
   
6. Find best definition via olcxOrderRefsAndGotoDefinition()
   
7. Navigate to definition position</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_key_data_structures">8.6.4. Key Data Structures</h4>
<div class="sect4">
<h5 id="_browser_stack_sessiondata_browserstack">Browser Stack (<code>sessionData.browserStack</code>)</h5>
<div class="paragraph">
<p>The browser stack is the runtime data structure for symbol navigation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct {
    OlcxReferences *top;           // Current symbol being browsed
    OlcxReferences *root;          // Stack base
} OlcxReferencesStack;

typedef struct {
    Reference *current;            // Current reference
    Reference *references;         // All references for symbol
    SymbolsMenu *symbolsMenu;      // Available symbols for selection
    Position callerPosition;       // Where lookup was initiated
    ServerOperation operation;     // Type of operation (OLO_PUSH, etc.)
} OlcxReferences;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_reference_information">Reference Information</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct {
    Position position;             // File, line, column
    Usage usage;                   // UsageDefined, UsageDeclared, UsageUsed
    struct Reference *next;        // Linked list of references
} Reference;

typedef struct {
    char *linkName;               // Symbol name with scope information
    Type type;                    // Symbol type (function, variable, etc.)
    Storage storage;              // Storage class
    Scope scope;                  // Visibility scope
    int includedFileNumber;       // File containing symbol
    Reference *references;        // All references to this symbol
} ReferenceItem;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database_operations">8.6.5. Database Operations</h4>
<div class="sect4">
<h5 id="_database_creation_create">Database Creation (-create)</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Parse all project files using C/Yacc parsers</p>
</li>
<li>
<p>Generate <code>ReferenceItem</code> entries for each symbol</p>
</li>
<li>
<p>Create <code>Reference</code> entries for each symbol usage</p>
</li>
<li>
<p>Write structured records to <code>.cx</code> files</p>
</li>
<li>
<p>Build hash-based index for fast lookup</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_database_updates_update">Database Updates (-update)</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Full Update</strong>: Rebuild entire database</p>
</li>
<li>
<p><strong>Fast Update</strong>: Only process modified files based on timestamps</p>
</li>
<li>
<p><strong>Incremental</strong>: Smart detection of changed dependencies</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_symbol_lookup_olo_push_operations">Symbol Lookup (OLO_PUSH operations)</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>scanReferencesToCreateMenu(symbolName)</code> loads symbol data</p>
</li>
<li>
<p><code>createSelectionMenu()</code> builds navigation menus</p>
</li>
<li>
<p><code>olProcessSelectedReferences()</code> populates browser stack</p>
</li>
<li>
<p><code>olcxOrderRefsAndGotoDefinition()</code> finds best definition</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lsp_integration_challenges">8.6.6. LSP Integration Challenges</h4>
<div class="sect4">
<h5 id="_architectural_mismatch">Architectural Mismatch</h5>
<div class="paragraph">
<p>The current architecture was designed for <strong>batch processing</strong> and <strong>persistent databases</strong>, while LSP requires <strong>on-demand processing</strong> and <strong>responsive queries</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Current LSP Problems:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Persistent File Dependency</strong>: LSP <code>findDefinition()</code> calls <code>scanReferencesToCreateMenu()</code> which expects pre-existing <code>.cx</code> files</p>
</li>
<li>
<p><strong>Project-Wide Requirement</strong>: Full project analysis required before individual file operations</p>
</li>
<li>
<p><strong>Batch Processing Model</strong>: No support for incremental, per-request symbol resolution</p>
</li>
<li>
<p><strong>Cold Start Problem</strong>: New projects have no <code>.cx</code> files, causing all LSP operations to fail</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Error Flow in LSP Mode:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">LSP textDocument/definition request

findDefinition() called

scanReferencesToCreateMenu() called

No .cx files exist  empty results

browserStack remains empty

All definition requests return same default position</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_performance_characteristics">Performance Characteristics</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">File-Based (.cx)</th>
<th class="tableblock halign-left valign-top">On-Demand Parsing</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cold Start</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires <code>-create</code> first</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parse file immediately</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Warm Queries</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O(1) hash lookup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O(file_size) parsing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory Usage</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low (streaming)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High (in-memory cache)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Incremental Updates</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart file tracking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per-file invalidation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Multi-project</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Separate databases</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Workspace-scoped</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A proposal for a unified symbol database architecture has been documented. See <a href="16-proposed-refactorings.html#unified-symbol-database">Proposed Unified Symbol Database</a> in the Proposed Refactorings chapter.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cxfile">8.6.7. CXFILE</h4>
<div class="paragraph">
<p>The current implementation of the reference database is file based,
with an optimized storage format.</p>
</div>
<div class="paragraph">
<p>There is limited support to automatically keep these updated during an
edit-compile cycle, you might have to update manually now and then.</p>
</div>
<div class="paragraph">
<p>The project settings (or command line options) indicate where the
file(s) are created and one option controls the number of files to be
used, <code>-refnum</code>.</p>
</div>
<div class="paragraph">
<p>This file (or files) contains compact, but textual representations of
the cross-reference information. Format is somewhat complex, but here
are somethings that I think I have found out:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the encoding has single character markers which are listed at the top
of cxfile.c</p>
</li>
<li>
<p>the coding seems to often start with a number and then a character,
such as '4l' (4 ell) means line 4, 23c mean column 23</p>
</li>
<li>
<p>references seems to be optimized to not repeat information if it
would be a repetition, such as '15l3cr7cr' means that there are two
references on line 15, one in column 3 the other in column 7</p>
</li>
<li>
<p>so there is a notion of "current" for all values which need not be
repeated</p>
</li>
<li>
<p>e.g. references all use 'fsulc' fields, i.e. file, symbol index,
usage, line and column, but do not repeat a 'fsulc' as long as it is
the same</p>
</li>
<li>
<p>some "fields" have a length indicator before, such as filenames
('6:/abc.c') indicated by ':' and version information ('34v file
format: C-xrefactory 1.6.0 ') indicated by 'v'.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So a line might say</p>
</div>
<div class="literalblock">
<div class="content">
<pre>12205f 1522108169p m1ia 84:/home/...</pre>
</div>
</div>
<div class="paragraph">
<p>The line identifies the file with id 12205. The file was last included
in an update of refs at sometime which is identified by 1522108169
(mtime), has not been part of a full update of xrefs, was mentioned on
the command line. (I don&#8217;t know what the 'a' means&#8230;&#8203;) Finally, the
file name itself is 84 characters long.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TODO: Build a tool to decipher this so that tests can query the
generated data for expected data. This is now partly ongoing in the
'utils' directory.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_reference_database_reading">8.6.8. Reference Database Reading</h4>
<div class="paragraph">
<p>All information about an externally visible symbol is stored in one,
and only one reference file, determined by hashing the linkname of the
symbol. So it will always suffice to read one reference file when
consulting the reference database (in the form of CXFILE) for a
symbol.</p>
</div>
<div class="paragraph">
<p>The reading of the CXFILE format is controlled by
`scanFunctionTable`s. These consists of a list of entries, one for
each key/tag/recordCode (see format description above) that the scan
will process.</p>
</div>
<div class="paragraph">
<p>As the reference file reading encounters a key/tag/recordCode it will
consult the table and see if there is an entry pointing to a handler
function for that key/tag/recordCode. If so, it will be called.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_editor_plugin">8.7. Editor Plugin</h3>
<div class="paragraph">
<p>The editor plugin has three different responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>serve as the UI for the user when interacting with certain <code>c-xref</code>
related functions</p>
</li>
<li>
<p>query <code>c-xref server</code> for symbol references and support navigating
these in the source</p>
</li>
<li>
<p>initiate source code operations ("refactorings") and execute the
resulting edits</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically Emacs (and probably other editors) starts <code>c-xref</code> in
"server-mode" using <code>-server</code> which connects the editor
with <code>c-xref</code> through stdout/stdin. If you have <code>(setq
c-xref-debug-mode t)</code> this command is logged in the <code>*Messages*</code> buffer
with the prefix "calling:".</p>
</div>
<div class="paragraph">
<p>Commands are sent from the editor to the server on its standard input.
They looks very much like normal command line options, and in fact
<code>c-xref</code> will parse that input in the same way using the same
code. When the editor sends an <code>end-of-options</code> line, the server will
start executing whatever was sent, and return some information in the
file given as an <code>-o</code> option when the editor starts the <code>c-xref</code>
server process. The file is named and created by the editor and
usually resides in <code>/tmp</code>. With <code>c-xref-debug-mode</code> set to on this is
logged as "sending:". If you <code>(setq c-xref-debug-preserve-tmp-files
t)</code> Emacs will also not delete the temporary files it creates so that
you can inspect them afterwards.</p>
</div>
<div class="paragraph">
<p>When the server has finished processing the command and placed the
output in the output file it sends a <code>&lt;sync&gt;</code> reply.</p>
</div>
<div class="paragraph">
<p>The editor can then pick up the result from the output file and do
what it needs to do with it ("dispatching:").</p>
</div>
<div class="sect3">
<h4 id="_invocations">8.7.1. Invocations</h4>
<div class="paragraph">
<p>The editor invokes a new <code>c-xref</code> process for the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Refactoring</p>
<div class="paragraph">
<p>Each refactoring operation calls a new instance of <code>c-xref</code>?</p>
</div>
</li>
<li>
<p>Create Project</p>
<div class="paragraph">
<p>When a <code>c-xref</code> function is executed in the editor and there is no
project covering that file, an interactive "create project" session is
started, which is run by a separate <code>c-xref</code> process.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_buffers">8.7.2. Buffers</h4>
<div class="paragraph">
<p>There is some magical editor buffer management happening inside of
<code>c-xref</code> which is not clear to me at this point. Basically it looks
like the editor-side tries to keep the server in sync with which
buffers are opened with what file&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>At this point I suspect that <code>-preload &lt;file1&gt; &lt;file2&gt;</code> means that the
editor has saved a copy of <code>&lt;file1&gt;</code> in <code>&lt;file2&gt;</code> and requests the server
to set up a "buffer" describing that file and use it instead of the
<code>&lt;file1&gt;</code> that recides on disk.</p>
</div>
<div class="paragraph">
<p>This is essential when doing refactoring since the version of the file
most likely only exists in the editor, so the editor has to tell the
server the current content somehow, this is the <code>-preload</code> option.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_editor_server">8.8. Editor Server</h3>
<div class="paragraph">
<p>When serving an editor the c-xrefactory application is divided into
the server, <em>c-xref</em> and the editor part, at this point only Emacs:en
are supported so that&#8217;s implemented in the
<code>editor/Emacs</code>-packages.</p>
</div>
<div class="sect3">
<h4 id="_interaction">8.8.1. Interaction</h4>
<div class="paragraph">
<p>The initial invocation of the edit server creates a process with which
communication is over stdin/stdout using a protocol which from the editor
is basically a version of the command line options.</p>
</div>
<div class="paragraph">
<p>When the editor has delivered all information to the server it sends
'end-of-option' as a command and the edit server processes whatever it
has and responds with <code>&lt;sync&gt;</code> which means that the editor can fetch
the result in the file it named as the output file using the '-o'
option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As long as the communication between the editor and the server
is open, the same output file will be used. This makes it hard to
catch some interactions, since an editor operation might result in
multiple interactions, and the output file is then re-used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Setting the emacs variable <code>c-xref-debug-mode</code> forces the editor to
copy the content of such an output file to a separate temporary file
before re-using it.</p>
</div>
<div class="paragraph">
<p>For some interactions the editor starts a completely new and fresh
<code>c-xref</code> process, see below. And actually you can&#8217;t do refactorings
using the server, they have to be separate calls. (Yes?) I have yet to
discover why this design choice was made.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many things in the sources that handles refactorings
separately, such as <code>refactoring_options</code>, which is a separate copy of
the options structure used only when refactoring.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_protocol">8.8.2. Protocol</h4>
<div class="paragraph">
<p>Communication between the editor and the server is performed using
text through standard input/output to/from <em>c-xref</em>. The protocol is
defined in src/protocol.tc and must match <code>editor/emacs/c-xrefprotocol.el</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the protocol only caters for the server&#8594;editor part,
the editor&#8594;server part consists of command lines resembling the command
line options and arguments, and actually is handled by the same code.</p>
</div>
<div class="paragraph">
<p>The file <code>protocol.tc</code> is included in <code>protocol.h</code> and <code>protocol.c</code>
which generates definitions and declarations for the elements through
using some macros.</p>
</div>
<div class="paragraph">
<p>There is a similar structure with <em>c-xrefprotocol.elt</em> which
includes <em>protocol.tc</em> to wrap the PROTOCOL_ITEMs into
<code>defvar</code>s.</p>
</div>
<div class="paragraph">
<p>There is also some Makefile trickery that ensures that the C and elisp
impementations are in sync.</p>
</div>
<div class="paragraph">
<p>One noteable detail of the protocol is that it carries strings in their native format,
utf-8. This means that lengths need to indicate <em>characters</em> not bytes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_of_server">8.8.3. Invocation of server</h4>
<div class="paragraph">
<p>The editor fires up a server and keeps talking over the established
channel (elisp function 'c-xref-start-server-process'). This probably
puts extra demands on the memory management in the server, since it
might need to handle multiple information sets and options (as read
from a .cxrefrc-file) for multiple projects simultaneously over a
longer period of time. (E.g. if the user enters the editor starting
with one project and then continues to work on another then new
project options need to be read, and new reference information be
generated, read and cached.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TODO: Figure out and describe how this works by looking at the
elisp-sources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>FINDINGS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>c-xref-start-server-process in c-xref.el</p>
</li>
<li>
<p>c-xref-send-data-to-running-process in c-xref.el</p>
</li>
<li>
<p>c-xref-server-call-refactoring-task in c-xref.el</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_communication_protocol">8.8.4. Communication Protocol</h4>
<div class="paragraph">
<p>The editor server is started using the appropriate command line option
and then it keeps the communication over stdin/stdout open.</p>
</div>
<div class="paragraph">
<p>The editor part sends command line options to the server, which looks
something like (from the read_xrefs test case):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>-encoding=european -olcxpush -urldirect  "-preload" "&lt;file&gt;" "-olmark=0" "-olcursor=6" "&lt;file&gt;" -xrefrc ".c-xrefrc" -p "&lt;project&gt;"
end-of-options</pre>
</div>
</div>
<div class="paragraph">
<p>In this case the "-olcxpush" is the operative command which results in
the following output</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;goto&gt;
 &lt;position-lc line=1 col=4 len=66&gt;CURDIR/single_int1.c&lt;/position-lc&gt;
&lt;/goto&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>As we can see from this interaction, the server will handle (all?)
input as a command line and manage the options as if it was a command
line invocation.</p>
</div>
<div class="paragraph">
<p>This explains the intricate interactions between the main program and
the option handling.</p>
</div>
<div class="paragraph">
<p>The reason behind this might be that a user of the editor might be
editing files on multiple projects at once, so every
interrogation/operation needs to clearly set the context of that
operation, which is what a user would do with the command line
options.</p>
</div>
</div>
<div class="sect3">
<h4 id="_olcx_naming">8.8.5. OLCX Naming</h4>
<div class="paragraph">
<p>It seems that all on-line editing server functions have an <code>olcx</code>
prefix, "On-Line C-Xrefactory", maybe&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring">8.9. Refactoring</h3>
<div class="paragraph">
<p>This is of course, the core in why I want to restore this, to get at its refactoring capabilities. So far, much is not understood, but here are some bits and pieces.</p>
</div>
<div class="sect3">
<h4 id="_editor_interface">8.9.1. Editor interface</h4>
<div class="paragraph">
<p>One thing that really confused me in the beginning was that the editor, primarily Emacs, don&#8217;t use the actual server that it has started for refactoring operations (and perhaps for other things also?). Instead it creates a separate instance with which it talks to about one refactoring.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve just managed to create the first automatic test for refactorings, <code>olcx_refactory_rename</code>. It was created by running the sandboxed emacs to record the communication and thus finding the commands to use.</p>
</div>
<div class="paragraph">
<p>Based on this learning it seems that a refactoring typically is a single invocation of <code>c-xref</code> with appropriate arguments (start &amp; stop markers, the operation, and so on) and the server then answers with a sequence of operations, like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;goto&gt;
 &lt;position-off off=3 len=&lt;n&gt;&gt;CURDIR/test_source/single_int1.c&lt;/position-off&gt;
&lt;/goto&gt;
&lt;precheck len=&lt;n&gt;&gt; single_int_on_line_1_col_4;&lt;/precheck&gt;
&lt;replacement&gt;
 &lt;str len=&lt;n&gt;&gt;single_int_on_line_1_col_4&lt;/str&gt;  &lt;str len=&lt;n&gt;&gt;single_int_on_line_1_col_44&lt;/str&gt;
&lt;/replacement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interactions">8.9.2. Interactions</h4>
<div class="paragraph">
<p>I haven&#8217;t investigated the internal flow of such a sequence, but it is starting to look like <code>c-xref</code> is internally re-reading the initialization, I&#8217;m not at this point sure what this means, I hope it&#8217;s not internal recursion&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_extraction">8.9.3. Extraction</h4>
<div class="paragraph">
<p>Each type of refactoring has it&#8217;s own little "language". E.g. extracting a method/function using <code>-refactory -rfct-extract-function</code> will return something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;extraction-dialog type=newFunction_&gt; &lt;str len=20&gt;	newFunction_(str);
&lt;/str&gt;
 &lt;str len=39&gt;static void newFunction_(char str[]) {
&lt;/str&gt;
 &lt;str len=3&gt;}

&lt;/str&gt;
  &lt;int val=2 len=0&gt;&lt;/int&gt;
&lt;/extraction-dialog&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So there is much logic in the editor for this. I suspect that the three <code>&lt;str&gt;</code> parts are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>what to replace the current region with</p>
</li>
<li>
<p>what to place before the current region</p>
</li>
<li>
<p>what to place after the current region</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this is correct then all extractions copy the region verbatim and then the server only have to figure out how to "glue" that to a semantically correct call/argument list.</p>
</div>
<div class="paragraph">
<p>As a side note the editor asks for a new name for the function and then calls the edit server with a rename request (having preloaded the new source file(s) of course).</p>
</div>
</div>
<div class="sect3">
<h4 id="_protocol_2">8.9.4. Protocol</h4>
<div class="paragraph">
<p>Dechiffrering the interaction between an editor and the edit server in
<code>c-xrefactory</code> isn&#8217;t easy. The protocol isn&#8217;t very clear or
concise. Here I&#8217;m starting to collect the important bits of the
invocation, the required and relevant options and the returned
information.</p>
</div>
<div class="paragraph">
<p>The test cases for various refactoring operations should give you some
more details.</p>
</div>
<div class="paragraph">
<p>All of these require a <code>-p</code> (project) option to know which c-xref
project options to read.</p>
</div>
<div class="sect4">
<h5 id="_general_principles">General Principles</h5>
<div class="paragraph">
<p>Refactorings are done using a separate invocation, the edit server
mode cannot handle refactorings. At least that is how the Emacs client
does it (haven&#8217;t looked at the Jedit version).</p>
</div>
<div class="paragraph">
<p>I suspect that it once was a single server that did both the symbol
management and the refactoring as there are remnants of a separate
instance of the option structure named "refactoringOptions". Also the
check for the refactoring mode is done using
<code>options.refactoringRegime == RegimeRefactory</code> which seems strange.</p>
</div>
<div class="paragraph">
<p>Anyway, if the refactoring succeeds the suggested edits is as per usual
in the communications buffer.</p>
</div>
<div class="paragraph">
<p>However, there are a couple of cases where the communcation does not
end there. Possibly because the client needs to communicate some
information back before the refactoring server can finish the job,
like presenting some menu selection.</p>
</div>
<div class="paragraph">
<p>My guess at this point is that it is the refactoring
server that closes the connection when it is done&#8230;&#8203;</p>
</div>
</div>
<div class="sect4">
<h5 id="_rename">Rename</h5>
<div class="paragraph">
<p><strong>Invocation:</strong> <code>-rfct-rename -renameto=NEW_NAME -olcursor=POSITION FILE</code></p>
</div>
<div class="paragraph">
<p><strong>Semantics:</strong> The symbol under the cursor (at POSITION in FILE) should
be renamed (replaced at all occurrences) by NEW_NAME.</p>
</div>
<div class="paragraph">
<p><strong>Result:</strong> sequence of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;goto&gt;
 &lt;position-off off=POSITION len=N&gt;FILE&lt;/position-off&gt;
&lt;/goto&gt;
&lt;precheck len=N&gt;STRING&lt;/precheck&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>followed by sequence of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;goto&gt;
 &lt;position-off off=POSITION len=N&gt;FILE&lt;/position-off&gt;
&lt;/goto&gt;
&lt;replacement&gt;
 &lt;str len=N&gt;ORIGINAL&lt;/str&gt;  &lt;str len=N&gt;REPLACEMENT&lt;/str&gt;
&lt;/replacement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_protocol_messages">Protocol Messages</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;goto&gt;{position-off}&lt;/goto&gt; &#8594; editor</dt>
<dd>
<p>Request the editor to move cursor to the indicated position (file, position).</p>
</dd>
<dt class="hdlist1">&lt;precheck len={int}&gt;{string}&lt;/precheck&gt; &#8594; editor</dt>
<dd>
<p>Requests that the editor verifies that the text under the cursor matches the string.</p>
</dd>
<dt class="hdlist1">&lt;replacement&gt;{str}{str}&lt;/replacement&gt;</dt>
<dd>
<p>Requests that the editor replaces the string under the cursor, which should be 'string1', with 'string2'.</p>
</dd>
<dt class="hdlist1">&lt;position-off off={int} len={int}&gt;{absolute path to file}&lt;/position-off&gt;</dt>
<dd>
<p>Indicates a position in the given file. 'off' is the character position in the file.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_memory_handling">8.9.5. Memory handling</h4>
<div class="paragraph">
<p>Memory may be dynamically allocated using <code>malloc()</code> in which case it
must be managed in the same manner as all <code>malloced</code> memory should to
avoid memory leaks or pointer problems. This is used mostly for local
and temporary areas.</p>
</div>
<div class="paragraph">
<p>But memory can also be locally managed using the structure <code>Memory</code>
and related functions.</p>
</div>
<div class="sect4">
<h5 id="_the_memory_type">The Memory type</h5>
<div class="paragraph">
<p>Memory allocation using the <code>Memory</code> type allows managing memory
locally and separately depending it its use. E.g. the primary memory
is <code>cxMemory</code> where all collected references are stored including
reference tables and other management areas. This type of memory can
easily be discarded, e.g. when a file is completely analyzed or a
refactoring is complete.</p>
</div>
<div class="paragraph">
<p>Separate memory areas are managed through <code>ppmMemory</code>,
<code>fileTableMemory</code>, macroArgumentsMemory` and <code>macroBodyMemory</code> and
possibly others. This list indicate that this type of memory is used
because the amount of source to be analysed may be so large that it
does not fit at the same time and need to be cached/discarded and
restored as needed.</p>
</div>
<div class="paragraph">
<p>The <code>Memory</code> type allows both re-initializing with a different size
and the optional choice to be notified when overflow happens using an
<code>overflowHandler</code> function.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_option_memory">8.9.6. Option Memory</h4>
<div class="paragraph">
<p>The memory handling for options deserves special explanation and attention.</p>
</div>
<div class="paragraph">
<p>When defining options, from the command line, options file or piped
from an editor process, the strings need to be preserved and
stored. This is done by "dynamically" allocating such areas in the
"options memory", <code>optMemory</code>.</p>
</div>
<div class="paragraph">
<p>But since this is a integral part of the options structure, whenever
an <code>Options</code> structure is copied, special care has to be taken so that
the fields in the target structure points into the memory area of the
target structure and not, as they did in the original structure, into
the memory of the source structure.</p>
</div>
<div class="paragraph">
<p>There are functions that, through tricky memory arithmetic, adjust all
pointers to point correctly. To this end, all memory locations in an
<code>Options</code> structure are collected in a linked list which can be
traversed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the nodes in the linked list are also allocated in the "dynamic"
memory of the Options structure.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">8.10. Configuration</h3>
<div class="paragraph">
<p>The legacy <code>c-xref</code> normally, in "production", uses a common configuration file in the
users home directory, <code>.c-xrefrc</code>. When a new project is defined its options will be
stored in this file as a new section.</p>
</div>
<div class="paragraph">
<p>It is possible to point to a specific configuration file using the command line option
<code>-xrefrc</code> which is used extensively in the tests to isolate them from the users
configuration.</p>
</div>
<div class="paragraph">
<p>Each "project" or "section" requires a name of the "project", which is the argument to
the <code>-p</code> command line option. And it may contain most other command line options on one
line each. These are always read, unless <code>-no-stdop</code> is used, before anything else. This
allows for different "default" options for each project.</p>
</div>
<div class="sect3">
<h4 id="_options">8.10.1. Options</h4>
<div class="paragraph">
<p>There are three possible sources for options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration files (~/.c-xrefrc)</p>
</li>
<li>
<p>Command line options at invocation, including server</p>
</li>
<li>
<p>Piped options sent to the server in commands</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all options are relevant in all cases.</p>
</div>
<div class="paragraph">
<p>All options sources uses exactly the same format so that the same code for decoding them can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_logic">8.10.2. Logic</h4>
<div class="paragraph">
<p>When the editor has a file open it needs to "belong" to a project. The
logic for finding which is very intricate and complicated.</p>
</div>
<div class="paragraph">
<p>In this code there is also checks for things like if the file is
already in the index, if the configuration file has changed since last
time, indicating there are scenarios that are more complicated (the
server, obviously).</p>
</div>
<div class="paragraph">
<p>But I also think this code should be simplified a lot.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modules">9. Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The current state of <code>c-xrefactory</code> is not such that clean modules can
easily be identified and located. This is obviously one important goal
of the continuing refactoring work.</p>
</div>
<div class="paragraph">
<p>To be able to do that we need to understand the functionality enough
so that clusters of code can be refactored to be more and more clear
in terms of responsibilities and interfaces.</p>
</div>
<div class="paragraph">
<p>This section makes a stab at identifying some candidated to modules,
as illustrated by the component diagram for <code>cxrefCore</code>.</p>
</div>
<div class="sect2">
<h3 id="_yylex">9.1. Yylex</h3>
<div class="sect3">
<h4 id="_responsibilities">9.1.1. Responsibilities</h4>
<div class="ulist">
<ul>
<li>
<p>Transform source text to sequences of lexems and additional
information</p>
</li>
<li>
<p>Register and apply C pre-processor macros and defines as well as
defines made as command line options (<code>-D</code>)</p>
</li>
<li>
<p>Handle include files by pushing and poping read contexts</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface">9.1.2. Interface</h4>
<div class="paragraph">
<p>The <code>yylex</code> module has the standard interface required by any
<code>yacc</code>-based parser, which is a simple <code>yylex(void)</code> function.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parser">9.2. Parser</h3>

</div>
<div class="sect2">
<h3 id="_xref">9.3. Xref</h3>

</div>
<div class="sect2">
<h3 id="_server">9.4. Server</h3>

</div>
<div class="sect2">
<h3 id="_refactory">9.5. Refactory</h3>

</div>
<div class="sect2">
<h3 id="_cxref">9.6. Cxref</h3>

</div>
<div class="sect2">
<h3 id="_main">9.7. Main</h3>

</div>
<div class="sect2">
<h3 id="_memory">9.8. Memory</h3>
<div class="sect3">
<h4 id="_background_2">9.8.1. Background</h4>
<div class="paragraph">
<p>Although the memory "module" is not shown in the component diagram, it is very
important. And it has also been a source for grievances and confusion as it is, and
probably still are, contrieved and not so easy to understand.</p>
</div>
<div class="paragraph">
<p>The main "design" restricition for the design of the memory handling is the fact that in
the early days, actual memory was scarce. To be able to cross-reference anything except
the smallest systems, the fact that the amount of memory available was insufficient had
to be handled.</p>
</div>
<div class="paragraph">
<p>Most of the memory types uses a statically allocated area inside which allocation can be
done, this applies to memory for pre-processor information for example. These sizes
could be extended only by re-compilation with a larger size for that type of memory.</p>
</div>
<div class="paragraph">
<p>However, for the most important memory type, the <code>cxMemory</code>, it could be handled
dynamically by detecting the out-of-memory situation and then discard, flush and re-use
the memory.</p>
</div>
<div class="paragraph">
<p>The size of the <code>cxMemory</code> could also be extended up to the defined maximum size.</p>
</div>
<div class="paragraph">
<p>This in turn, forced the implementation of a caching strategy, since this overflow may
happen during the reading of a file. This incurred much complexity.</p>
</div>
</div>
<div class="sect3">
<h4 id="_future_direction">9.8.2. Future direction</h4>
<div class="paragraph">
<p>As virtual memory for a process in a modern OS is much larger than in the 1990&#8217;s it
would not be impossible to remove this strategy of overflow detection and
recovery.</p>
</div>
<div class="paragraph">
<p>A possibility to in an orderly fashion flush and reuse memory would still be needed.</p>
</div>
<div class="paragraph">
<p>A new type of memory, <code>FlushableMemory</code>, has been implemented but as yet, not officially
replaced the current memory handling.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cxfile_2">9.9. Cxfile</h3>
<div class="sect3">
<h4 id="_responsibilities_2">9.9.1. Responsibilities</h4>
<div class="paragraph">
<p>Read and write the CXref database in "plain" text format.</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_format">9.9.2. File format</h4>
<div class="paragraph">
<p>The current file format for the cross-reference data consists of records with the general format</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;number&gt;&lt;key&gt;[&lt;value&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>There are two important types of lines, a file information line and a
symbol information line.</p>
</div>
<div class="paragraph">
<p>The actual keys are documented in <code>cxfile.c</code>, but here is an example
file information line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>32571f  1715027668m 21:/usr/include/ctype.h</pre>
</div>
</div>
<div class="paragraph">
<p>First we have two simple value/key pairs. We see "32571f" indicating
that this is file information for file with file number 32571.</p>
</div>
<div class="paragraph">
<p>Secondly we have "1715027668m". This is the modification time of the
file which is stored to be able to see if that file has been updated
since the reference database was last written.</p>
</div>
<div class="paragraph">
<p>And the third part is "21:/usr/include/ctype.h", which is of a record
type that is a bit more complex. The number is the length of the
value. The ':' indicates that the record is a filename.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_c_xref_el">9.10. c-xref.el</h3>

</div>
<div class="sect2">
<h3 id="_c_xrefactory_el">9.11. c-xrefactory.el</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structures">10. Data Structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a lot of different data structures used in <code>c-xrefactory</code>.
This is a first step towards visualising some of them.</p>
</div>
<div class="sect2">
<h3 id="_referenceitems_and_references">10.1. ReferenceItems and References</h3>
<div class="paragraph">
<p>This is a fundamental pair. A <code>ReferenceItem</code> is the symbol that
occurs at the locations that <code>References</code> indicate.</p>
</div>
<div class="paragraph">
<p>Each <code>ReferenceItem</code> has a linked list of `Reference`s, each denoting
one occurence of that "symbol".</p>
</div>
</div>
<div class="sect2">
<h3 id="_symbols_and_references">10.2. Symbols and References</h3>
<div class="paragraph">
<p>There is also a structure called <code>Symbol</code>. But, why is there no
connection between the symbols and the references?!?</p>
</div>
<div class="paragraph">
<p>So what are these actually?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
class Symbol {
char *name
Position position
SymbolBits bits
}
Symbol o-- Symbol : next

class SymbolList {
}
SymbolList o-- Symbol : symbol
SymbolList o-- SymbolList : next

class ReferencesItem {
char *name
ReferencesBits bits
}
ReferencesItem o-- Reference : references
ReferencesItem o-- ReferencesItem : next

class Reference {
Usage usage
Position position
}
Reference o-- Reference : next</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_files_and_buffers">10.3. Files and Buffers</h3>
<div class="paragraph">
<p>Many strange things are going on with reading files so that is not completely understood yet.</p>
</div>
<div class="paragraph">
<p>Here is an initial attempt at illustrating how some of the file and text/lexem buffers are related.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).
class FileDescriptor {
}
FileDescriptor o-- LexemBuffer : lexemBuffer

class LexemBuffer {
  Lexem[] lexemStream
}
LexemBuffer o-- CharacterBuffer : buffer

class CharacterBuffer {
  char[] : chars
}

class LexInput {
  char* : macroName
  InputType : inputType
}
LexInput --&gt; LexemBuffer : beginningOfBuffer, endOfBuffer, currentLexemP (into .lexemStream)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It would be nice if the <code>LexInput</code> structure could point to a
<code>LexemBuffer</code> instead of holding separate pointers which are
impossible to know what they actually point to&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This could be achieved if we could remove the CharacterBuffer
from LexemBuffer and make that a reference instead of a
composition. Then we&#8217;d need to add a CharacterBuffer to the structures
that has a LexemBuffer as a component (if they use it).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modes">10.4. Modes</h3>
<div class="paragraph">
<p><code>c-xrefactory</code> operates in different modes ("regimes" in original
<code>c-xref</code> parlance):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>xref - batch mode reference generation</p>
</li>
<li>
<p>server - editor server</p>
</li>
<li>
<p>refactory - refactory browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default mode is "xref". The command line options <code>-server</code> and <code>-refactory</code>
selects one of the other modes. Branching is done in the final lines in
<code>main()</code>.</p>
</div>
<div class="paragraph">
<p>The code for the modes are intertwined, probably through re-use of
already existing functionality when extending to a refactoring
browser.</p>
</div>
<div class="paragraph">
<p>One evidence for this is that the refactory module calls the "main
task" as a "sub-task".  This forces some intricate fiddling with the
options data structure, like copying it.  Which I don&#8217;t
fully understand yet.</p>
</div>
<div class="paragraph">
<p>TODO?: Strip away the various "regimes" into more separated concerns
and handle options differently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_options_2">10.5. Options</h3>
<div class="paragraph">
<p>The <code>Options</code> datastructure is used to collect options from the
command line as well as from options/configuration files and piped
options from the editor client using process-to-process
communication.</p>
</div>
<div class="paragraph">
<p>It consists of a collection of fields of the types</p>
</div>
<div class="ulist">
<ul>
<li>
<p>elementary types (bool, int, &#8230;&#8203;)</p>
</li>
<li>
<p>string (pointers to strings)</p>
</li>
<li>
<p>lists of strings (linked lists of pointers to strings)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_allocation_copying">10.5.1. Allocation &amp; Copying</h4>
<div class="paragraph">
<p>Options has its own allocation using <code>optAlloc</code> which allocates in a
separate area, currently part of the options structure and utilizing
"dynamic allocation" (<code>dm_</code> functions on the <code>Memory</code> structure).</p>
</div>
<div class="paragraph">
<p>The Options structure are copied multiple times during a session, both
as a backup (<code>savedOptions</code>) and into a separate options structure
used by the Refactorer (<code>refactoringOptions</code>).</p>
</div>
<div class="paragraph">
<p>Since the options memory is then also copied, all pointers into the
options memory need to be updated. To be able to do this, the options
structure contains lists of addresses that needs to by "shifted".</p>
</div>
<div class="paragraph">
<p>When an option with a string or string list value is modified the
option is registered in either the list of string valued options or
the list of string list valued options. When an options structure is
copied it must be performed using a deep copy function which "shifts"
those options and their values (areas in the options memory) in the
copy so that they point into the memory area of the copy, not the
original.</p>
</div>
<div class="paragraph">
<p>After the deep copy the following point into the option memory of the
copy</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the lists of string and string list valued options (option fields)</p>
</li>
<li>
<p>all string and string valued option fields that are used (allocated)</p>
</li>
<li>
<p>all list nodes for the used option (allocated)</p>
</li>
<li>
<p>all list nodes for the string lists (allocated)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_algorithms">11. Algorithms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code does not always explain the algorithms that it
implements. This chapter will ultimately be a description of various
algorithms used by <em>c-xrefactory</em>.</p>
</div>
<div class="sect2">
<h3 id="_how_is_an_extract_refactoring_performed">11.1. How is an Extract refactoring performed?</h3>
<div class="paragraph">
<p>The region (mark and point/cursor positions) is sent to the <em>c-xref</em>
server in a <code>-refactory -rfct-extract</code> command.</p>
</div>
<div class="paragraph">
<p>The server parses the relevant file and sets some information that can
be used in some prechecks that are then performed, such as structure
check, and then the server answers with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;extraction-dialog&gt;
    &lt;str .... /str&gt;
    &lt;str .... /str&gt;
    &lt;str .... /str&gt;
&lt;/extraction-dialog&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first string is the code that will replace the extracted code,
such as a call to the extracted function. The second string is the header
part that will preceed the extracted code ("preamble"), and the third is then of
course any code that needs to go after the extracted code ("postamble").</p>
</div>
<div class="paragraph">
<p>The actual code in the region is never sent to, or returned from, the
server. This is handled completely by the editor extension, and used
verbatim (except if it is a macro that is extracted, in which case
each line is terminated by the backslash) so no changes to that code
can be made.</p>
</div>
<div class="paragraph">
<p>The pre- and post-ambles might be of varying complexity. E.g. when
extracting a macro, the postamble can be completely empty. When
extracting a function both may contain code to transfer and restore
parameters into local variables to propagate in/out variables as
required.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The editor then requests a name from the user that it will use in a
rename operation that renames the default named
function/macro/variable.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_how_does">11.2. How does &#8230;&#8203;</h3>
<div class="paragraph">
<p>TBD.
== Development Environment</p>
</div>
</div>
<div class="sect2">
<h3 id="_developing_here_be_dragons">11.3. Developing, here be dragons&#8230;&#8203;</h3>
<div class="paragraph">
<p>First the code is <strong>terrible</strong>, lots of single and double character
variables (<code>cc</code>, <code>ccc</code>, ..) and lost of administration on local
variables rather than the structures that are actually there. And
there are also a lot of macros. Unfortunately macros are hard to
refactor to functions. (But I&#8217;m making progress&#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p>As there is no general way to refactor a macro to a function, various
techniques must be applied. I wrote <a href="https://www.responsive.se/thomas/2020/05/14/refactoring-macros-to-functions/">a blog post</a>
about one that have been fairly successful.</p>
</div>
<div class="paragraph">
<p>But actually it&#8217;s rather fun to be able to make small changes and
see the structure emerge, hone your refactoring and design skills,
and working on a project that started 20 years ago which still is
valuable, to me, and I hope, to others.</p>
</div>
<div class="paragraph">
<p>There should probably be a whole section on how to contribute and
develop <code>c-xrefactory</code> but until then here&#8217;s a short list of what
you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C development environment (GNU/Clang/Make/&#8230;&#8203;)</p>
</li>
<li>
<p>Unittests are written using <a href="https://github.com/cgreen-devs/cgreen"><code>Cgreen</code></a></p>
</li>
<li>
<p>Clean code and refactoring knowledge (to drive the code to a better and cleaner state)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Helpful would be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compiler building knowledge (in the general sense, Yacc, but AST:s
and symbol table stuff are heavily used)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_setup">11.4. Setup</h3>
<div class="paragraph">
<p>TBD.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building">11.5. Building</h3>
<div class="paragraph">
<p>You should be able build <code>c-xref</code> using something like (may have changed over time&#8230;&#8203;)</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cd src
make
make unit
make test</pre>
</div>
</div>
<div class="paragraph">
<p>But since the details of the building process are somewhat contrieved
and not so easy to see through, here&#8217;s the place where that should be
described.</p>
</div>
<div class="paragraph">
<p>One step in the build process was generating initialization information
for all the things in standard include files, which of course became
very dependent on the system you are running this on. This has now moved
into functions inside <code>c-xref</code> itself, like finding DEFINEs and include
paths.</p>
</div>
<div class="paragraph">
<p>The initial recovered c-xrefactory relied on having a working <em>c-xref</em>
for the current system. I don&#8217;t really know how they managed to do
that for all the various systems they were supporting.</p>
</div>
<div class="paragraph">
<p>Modern thinking is that you should always be able to build from
source, so this is something that needed change. We also want to
distribute <em>c-xref</em> as an el-get library which requires building from
source and should generate a version specific for the current system.</p>
</div>
<div class="paragraph">
<p><span class="line-through">The strategy selected, until some better idea comes along, is to try
to build a <em>c-xref.bs</em>, if there isn&#8217;t one already, from the sources in
the repository and then use that to re-generate the definitions and
rebuild a proper <em>c-xref</em>. See Bootstrapping.</span></p>
</div>
<div class="paragraph">
<p>We have managed to remove the complete bootstrapping step, so <code>c-xrefactory</code>
now builds like any other project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_versions">11.6. Versions</h3>
<div class="paragraph">
<p>The current sources are in 1.6.X range. This is the same as the orginal
xrefactory and probably also the proprietary C++ supporting version.</p>
</div>
<div class="paragraph">
<p>There is an option, "-xrefactory-II", that might indicate that
something was going on. But currently the only difference seems to be
if the edit server protocol output is in the form of non-structured
fprintf:s or using functions in the <code>ppc</code>-family (either calling
<code>ppcGenRecord()</code> or `fprint`ing using some PPC-symbol). This, and
hinted to in how the emacs-part starts the server and some initial
server option variables in refactory.c, indicates that the
communication from the editor and the refactory server is using
this. It does <strong>not</strong> look like this is a forward to next generation
attempt.</p>
</div>
<div class="paragraph">
<p>What we should do is investigate if this switch actually is used
anywhere but in the editor server context, and if so, if it can be
made the default and the 'non-xrefactory-II' communication removed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_coding">11.7. Coding</h3>
<div class="sect3">
<h4 id="_naming">11.7.1. Naming</h4>
<div class="paragraph">
<p><em>C-xref</em> started (probably) as a cross-referencer for the languages
supported (C, Java, C++), orginally had the name "xref" which became
"xrefactory" when refactoring support was added. And when Marin
released a "C only" version in 2009 most of all the "xref" references
and names was changed to "c-xref". So, as most software, there is a
history and a naming legacy to remember.</p>
</div>
<div class="paragraph">
<p>Here are some of the conventions in naming that are being used:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">olcx</dt>
<dd>
<p>"On-line CX" (Cross-reference) ?</p>
</dd>
<dt class="hdlist1">OLO</dt>
<dd>
<p>"On-line option" - some kind of option for the server</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_modules_and_include_files">11.7.2. Modules and Include Files</h4>
<div class="paragraph">
<p>The source code for <code>c-xrefactory</code> was using a very old C style with a
separate <code>proto.h</code> where all prototypes for all externally visible
functions were placed. Definitions are all over the place and it was
hard to see where data is actually declared. This must change into
module-oriented include-strategy.</p>
</div>
<div class="paragraph">
<p>Of course this will have to change into the modern x.h/x.c externally
visible interface model so that we get clean modules that can be
unittested.</p>
</div>
<div class="paragraph">
<p>The function prototypes have been now moved out to header files for
each "module". Some of the types have also done that, but this is
still a work in progress.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging">11.8. Debugging</h3>
<div class="paragraph">
<p>TBD. Attachning <code>gdb</code>, <code>server-driver</code>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><code>yaccp</code> from <code>src/.gdbinit</code> can ease the printing of Yacc semantic data fields&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>A helpful option is the recently added <code>-commandlog=&#8230;&#8203;</code> which allows
you to capture all command arguments sent to the server/xref process
to a file. This makes it possible to capture command sequences and
"replay" them. Useful both for debugging and creating tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing">11.9. Testing</h3>
<div class="sect3">
<h4 id="_unittests">11.9.1. Unittests</h4>
<div class="paragraph">
<p>There are very few unittests at this point, only covering single digit
percent of the code. The "units" in this project are unclear and
entangled so creating unittests is hard since it was not build to be
tested, test driven or even clearly modularized.</p>
</div>
<div class="paragraph">
<p>All unittests use <code>Cgreen</code> as the unittest framework. If you are
unfamiliar with it the most important point is that it can mock
functions, so you will find mock implementations of all external
functions for a module in a corresponding <code>&lt;module&gt;.mock</code> file.</p>
</div>
<div class="paragraph">
<p>Many modules are at least under test, meaning there is a
&lt;module&gt;_tests.c in the unittest directory. Often only containing an
empty test.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acceptance_tests">11.9.2. Acceptance Tests</h4>
<div class="paragraph">
<p>In the <code>tests</code> directory you will find tests that exercise the external
behaviour of <code>c-xref</code>. Some tests actually do only that, they wouldn&#8217;t
really count as tests.</p>
</div>
<div class="paragraph">
<p>Most acceptance tests are hacks at this point, Make-scripts tweaked
until it produces some expected output. But at least they get the
coverage up (working our way up to the mid 60%), and more are added as
bugs are found so they provide increasing confidence when developing.</p>
</div>
<div class="paragraph">
<p>There are two basic strategies for the tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>run a <code>c-xref</code> command, catch its output and verify</p>
</li>
<li>
<p>run a series of command using the EDIT_SERVER_DRIVER, collect output and results and verify</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some tests do not even test its output and only provide coverage.</p>
</div>
<div class="paragraph">
<p>Some tests do a very bad job at verifying, either because my
understanding at that time was very low, or because it is hard to
verify the output. E.g. the "test" for generate references are only
grepping the CXrefs files for some strings, not verifying that they
actually point to the correct place.</p>
</div>
<div class="paragraph">
<p>Hopefully this will change as the code gets into a better state and
the understanding grows.</p>
</div>
</div>
<div class="sect3">
<h4 id="_general_setup">11.9.3. General Setup</h4>
<div class="paragraph">
<p>Since all(?) <code>c-xref</code> operation rely on an options file which must
contain absolute file paths (because the server runs as a separate
process) it must be generated whenever the tests are to be run in a
different location (new clone, test was renamed, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>This is performed by using a common template in <code>tests</code> and a target
in <code>tests/Maefile.boilerplate</code>.</p>
</div>
<div class="paragraph">
<p>Each test should have a <code>clean</code> target that removes any temporary and
generated files, including the <code>.c-xrefrc</code> file and generated
references. This way it is easy to ensure that all tests have updated
<code>.c-xrefrc</code> files.</p>
</div>
</div>
<div class="sect3">
<h4 id="_edit_server_driver_tests">11.9.4. Edit Server Driver Tests</h4>
<div class="paragraph">
<p>Since many operations are performed from the editor, and the editor
starts an "edit server" process, many tests need to emulate this
behaviour.</p>
</div>
<div class="paragraph">
<p>The edit server session is mostly used for navigation. Refactorings
are actually performed as separate invocations of <code>c-xref</code>.</p>
</div>
<div class="paragraph">
<p>In <code>utils</code> there is a <code>server_driver.py</code> script, which will take as
input a file containing a sequence of commands. You can use this to
start an edit, refactory or reference server session and then feed it
with commands in the same fashion as an editor would do. The script
also handles the communication through the buffer file (see [Editor
Interface](./Design:-Editor-Interface)).</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_more_edit_server_tests">11.9.5. Creating More Edit Server Tests</h4>
<div class="paragraph">
<p>You can relatively easy re-create a sequence of interactions by using the
sandboxed Emacs in <code>tests/sandboxed_emacs</code>.</p>
</div>
<div class="paragraph">
<p>There are two ways to use it, "make spy" or "make pure". With the
"spy" an intermediate spy is injected between the editor and the edit
server, capturing the interaction to a file.</p>
</div>
<div class="paragraph">
<p>With "pure" you just get the editor setup with <code>c-xref-debug-mode</code> and
<code>c-xref-debug-preserve-tmp-files</code> on. This means that you can do what
ever editor interactions you want and see the communication in the
<code>*Messages*</code> buffer. See [Editor Interface](./Design:-Editor-Interface)
for details.</p>
</div>
<div class="paragraph">
<p>Once you have figure out which part of the <code>*Messages*</code> buffer are
interesting you can copy that out to a file and run
<code>utils/messages2commands.py</code> on it to get a file formatted for input
to <code>server_driver.py</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the <code>messages2commands</code> script converts all occurrences of the
current directory to CURDIR so it is handy to be in the same directory
as the sources when you run the conversion.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the <code>messages2commands</code> script removes any <code>-preload</code> so you
need to take care that the positions inside the buffers are not
changed between interactions lest the <code>-olcursor</code> and <code>-olmark</code> will
be wrong. (You can just undo the change after a refactoring or
rename). Of course this also applies if you want to mimic a sequence
of refactorings, like the <code>jexercise</code> move method example. Sources will
then change so the next refactoring works from content of buffers, so you
have to handle this specifically.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>-preload</code> is the mechanism where the editor can send modified
buffers to <code>c-xref</code> so thay you don&#8217;t have to save between
refactorings, which is particularly important in the case of extract
since the extraction creates a default name which the editor then does
a rename of.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_utilities">11.10. Utilities</h3>
<div class="sect3">
<h4 id="_covers">11.10.1. Covers</h4>
<div class="paragraph">
<p><code>utils/covers.py</code> is a Python script that, in some enviroments, can list which test cases execute a particular line.</p>
</div>
<div class="paragraph">
<p>This is handy when you want to debug or step through a particular part of the code.
Find a test that covers that particular line and run it using the debugger (usually <code>make debug</code> in the test directory).</p>
</div>
<div class="paragraph">
<p>Synopsis:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>covers.py &lt;file&gt; &lt;line&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sandboxed">11.10.2. Sandboxed</h4>
<div class="paragraph">
<p><code>utils/sandboxed</code> starts a sandboxed Emacs that uses the current elisp code and the <code>c-xref</code> from src.
This allows you to run a test changes without having to polute your own setup.</p>
</div>
<div class="paragraph">
<p>This actually runs the <code>tests/sandboxed_emacs</code> pure version, which also sets up a completely isolated Emacs environment with its own packages loaded, configuration etc.
See below.</p>
</div>
<div class="paragraph">
<p>Synopsis:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sandboxed</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_the_protocol">11.11. Debugging the protocol</h3>
<div class="paragraph">
<p>There is a "pipe spy" in <code>tests/sandboxed_emacs</code>. You can build the
spy using</p>
</div>
<div class="literalblock">
<div class="content">
<pre>make spy</pre>
</div>
</div>
<div class="paragraph">
<p>and then start a sandboxed Emacs which invokes the spy using</p>
</div>
<div class="literalblock">
<div class="content">
<pre>make</pre>
</div>
</div>
<div class="paragraph">
<p>This Emacs will be sandboxed to use its own .emacs-files and have HOME
set to this directory.</p>
</div>
<div class="paragraph">
<p>The spy will log the communication between Emacs and the <strong>real</strong>
<code>c-xref</code> (<code>src/c-xref</code>) in log files in <code>/tmp</code>.</p>
</div>
<div class="paragraph">
<p>NOTE that Emacs will invoke several instanced of what it believes is
the real <code>c-xref</code> so there will be several log files to inspect.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment">12. Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TBD.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decison_log">13. Decison Log</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we log all design and architectural decisions. Currently they are
stored separately. Most of the actual, historic, decisons are of
course lost.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_insights">14. Insights</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter contains notes of all insights, large and small, that I make as I work on this project.
These insights should at some point be moved to some other, more structured, part of this document.
But rather than trying to find a structure where each new finding fits, I&#8217;m making it easy to just dump them here.
We can refactor these into a better and better structure as we go.</p>
</div>
<div class="sect2">
<h3 id="_yacc_semantic_data">14.1. Yacc semantic data</h3>
<div class="paragraph">
<p>As per usual a Yacc grammar requires each non-terminal to have a type.
Those types are named after which types of data they collect and
propagate.  The names always starts with <code>ast_</code> and then comes the
data type.  For example if some non-terminal needs to propagate a
Symbol and a Position that structure would be called
<code>ast_symbolParameterPair</code> ("Pair" being thrown in there for good
measure&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Each of those structures also always carries a begin and end position
for that structure.  That means that any "ast" struct has three
fields, <code>begin</code>, <code>end</code> and the data.  The data are sometimes a struct,
like in this case, but can also be a single value, like an <code>int</code> or a
pointer to a <code>Symbol</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: Could not load PlantUML. Either require 'asciidoctor-diagram-plantuml' or specify the location of the PlantUML JAR(s) using the 'DIAGRAM_PLANTUML_CLASSPATH' environment variable. Alternatively a PlantUML binary can be provided (plantuml-native in $PATH).

class ast_symbolPositionPair {
Position begin
Position end
}

ast_symbolPositionPair *-- SymbolPositionPair : data

class SymbolPositionPair {
Symbol *symbol
Position position
}</pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="_proposed_refactorings" class="sect0">Proposed Refactorings</h1>
<div class="paragraph">
<p>This chapter documents larger refactoring proposals that would significantly improve code quality but require careful planning and implementation.</p>
</div>
<div class="sect1">
<h2 id="_lexinput_api_improvements">1. LexInput API Improvements</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_problem_statement">1.1. Problem Statement</h3>
<div class="paragraph">
<p>The macro expansion and collation code (<code>collate()</code>, <code>replaceMacroArguments()</code>, etc.) in <code>src/yylex.c</code> suffers from <strong>pointer parameter proliferation</strong>, making it difficult to understand and maintain. Functions pass 5-6 separate parameters to track buffer state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static char *collate(char *buffer, int *bufferSizeP, char **bufferWriteP,
                     char **leftHandLexemP, char **rightHandLexemP,
                     LexInput *actualArgumentsInput);

static void copyRemainingLexems(char *buffer, int *bufferSize, char **bufferWriteP,
                                char *nextLexemP, char *endOfInputLexems);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates several issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hard to track which pointers point into which buffers</p>
</li>
<li>
<p>Manual size/capacity management scattered throughout code</p>
</li>
<li>
<p>Easy to make mistakes with pointer arithmetic</p>
</li>
<li>
<p>Functions have 6+ parameters just for buffer management</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_current_architecture">1.2. Current Architecture</h3>
<div class="sect3">
<h4 id="_three_representations_of_lexem_streams">1.2.1. Three representations of lexem streams</h4>
<div class="paragraph">
<p>The codebase currently uses three different ways to represent lexem streams:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>LexemBuffer</strong> (structured, file-oriented)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Fixed-size embedded array: <code>char lexemStream[LEXEM_BUFFER_SIZE]</code></p>
</li>
<li>
<p>Metadata: <code>begin</code>, <code>read</code>, <code>write</code>, <code>position</code>, <code>fileOffset</code>, <code>backpatchPointer</code></p>
</li>
<li>
<p>Used for lexing from files/editor buffers</p>
</li>
<li>
<p>Full API for manipulation: <code>putLexemCode()</code>, <code>getLexemCode()</code>, etc.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><strong>LexInput</strong> (lightweight, pointer-based)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Just 3 pointers + metadata: <code>begin</code>, <code>read</code>, <code>write</code>, <code>macroName</code>, <code>inputType</code></p>
</li>
<li>
<p>Points to external memory (doesn&#8217;t own it)</p>
</li>
<li>
<p>Used for macro expansion pipelines</p>
</li>
<li>
<p><strong>NO manipulation API - just raw pointer access</strong></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><strong>MacroBody</strong> (persistent storage)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Pointer + length: <code>char *body</code>, <code>int size</code></p>
</li>
<li>
<p>Used for stored macro definitions</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_lexinput_buffer_sources">1.2.2. LexInput buffer sources</h4>
<div class="paragraph">
<p>LexInput can point to 5 different memory sources:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>LexemBuffer.lexemStream</code> - Fixed array in file descriptor</p>
</li>
<li>
<p><code>ppmAlloc()</code> - Preprocessor macro memory (dynamic)</p>
</li>
<li>
<p><code>mbmAlloc()</code> - Macro body memory (dynamic)</p>
</li>
<li>
<p><code>NULL</code> - Empty/missing arguments</p>
</li>
<li>
<p>External buffers from various sources</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_proposed_solution">1.3. Proposed Solution</h3>
<div class="sect3">
<h4 id="_add_lexinput_manipulation_api">1.3.1. Add LexInput manipulation API</h4>
<div class="paragraph">
<p>Currently, LexInput has <strong>zero manipulation functions</strong>. All operations are done via raw pointer manipulation. We need to add an API similar to LexemBuffer.</p>
</div>
</div>
<div class="sect3">
<h4 id="_phase_1_extend_lexinput_structure">1.3.2. Phase 1: Extend LexInput structure</h4>
<div class="paragraph">
<p>Add optional buffer management fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct {
    char *begin;        // Start of buffer
    char *read;         // Current read position
    char *write;        // Current write position (= end for read-only)
    char *macroName;    // Name of macro this input represents
    InputType inputType;
    // NEW fields:
    int allocatedSize;  // Total allocated size (0 if not owned/unknown)
    bool ownsBuffer;    // Whether this LexInput should manage/free the buffer
} LexInput;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Alternative considered but rejected: Create separate <code>WritableLexInput</code> type. Pro: Cleaner separation of read vs write. Con: Yet another type, conversion overhead, more complex API.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_phase_2_create_manipulation_api">1.3.3. Phase 2: Create manipulation API</h4>
<div class="paragraph">
<p>New file: <code>src/lexinput.c</code> and extend <code>src/input.h</code></p>
</div>
<div class="sect4">
<h5 id="_core_buffer_management">Core buffer management</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Creation
LexInput lexInputCreateOwned(int initialSize);     // Allocates managed buffer
LexInput lexInputCreateView(char *begin, char *end); // Read-only view

// Capacity management
void lexInputEnsureCapacity(LexInput *input, int additionalBytes);
void lexInputReallocIfNeeded(LexInput *input, int needed);
int lexInputRemainingCapacity(LexInput *input);

// Reading (advance read pointer)
LexemCode lexInputGetLexem(LexInput *input);
LexemCode lexInputPeekLexem(LexInput *input);  // Don't advance
bool lexInputHasMore(LexInput *input);          // read &lt; write
void lexInputSkipLexem(LexInput *input);        // Skip current lexem

// Writing (advance write pointer)
void lexInputPutLexemCode(LexInput *output, LexemCode lexem);
void lexInputPutLexemPosition(LexInput *output, Position pos);
void lexInputAppendBytes(LexInput *dest, char *src, int len);
void lexInputCopyLexem(LexInput *dest, LexInput *src); // Copy one lexem from src to dest

// Cleanup
void lexInputFree(LexInput *input);  // Only frees if ownsBuffer=true</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_phase_3_refactor_functions_to_use_lexinput_api">1.3.4. Phase 3: Refactor functions to use LexInput API</h4>
<div class="sect4">
<h5 id="_example_collate_before">Example: collate() before</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static char *collate(char *buffer,              // Destination buffer
                     int *bufferSizeP,          // Destination allocated size
                     char **bufferWriteP,       // Current write position
                     char **leftHandLexemP,     // Left operand read position
                     char **rightHandLexemP,    // Right operand read position
                     LexInput *actualArgumentsInput)  // Source arguments
{
    // Manual buffer management scattered throughout:
    *bufferSizeP = expandPreprocessorBufferIfOverflow(buffer, *bufferSizeP, *bufferWriteP);

    // Manual pointer arithmetic:
    int lexemLength = nextInputLexemP - lexemStart;
    memcpy(*bufferWriteP, lexemStart, lexemLength);
    *bufferWriteP += lexemLength;

    // Complex state tracking:
    char *lhs = *leftHandLexemP;
    char *endOfLexems = NULL;
    // ... many lines of pointer manipulation
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_example_collate_after">Example: collate() after</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static void collate(LexInput *output,           // Destination (manages its own buffer)
                    LexInput *leftOperand,      // Left operand (with read position)
                    LexInput *rightOperand,     // Right operand (with read position)
                    LexInput *actualArgumentsInput)
{
    // Clean, high-level operations:
    lexInputEnsureCapacity(output, estimatedSize);

    // Copy operations are explicit and clear:
    lexInputCopyLexem(output, leftOperand);
    lexInputCopyLexem(output, rightOperand);

    // State is encapsulated in LexInput structures
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_functions_to_refactor_priority_order">Functions to refactor (priority order)</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>collate()</strong> - Most complex, biggest win (yylex.c:1515)</p>
</li>
<li>
<p><strong>copyRemainingLexems()</strong> - Used by collate (yylex.c:1450)</p>
</li>
<li>
<p><strong>resolveMacroArgumentAsLeftOperand()</strong> - Complex pointer tracking (yylex.c:1465)</p>
</li>
<li>
<p><strong>replaceMacroArguments()</strong> - Many buffer operations (yylex.c:1717)</p>
</li>
<li>
<p><strong>expandMacroArgument()</strong> - Buffer management (yylex.c:1362)</p>
</li>
<li>
<p><strong>createMacroBodyAsNewInput()</strong> - Multiple buffers (yylex.c:1780)</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_benefits">1.4. Benefits</h3>
<div class="sect3">
<h4 id="_code_clarity">1.4.1. Code clarity</h4>
<div class="ulist">
<ul>
<li>
<p>Functions have 2-3 parameters instead of 6+</p>
</li>
<li>
<p>Clear ownership and boundaries</p>
</li>
<li>
<p>Self-documenting code (LexInput instead of 3 raw pointers)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_maintainability">1.4.2. Maintainability</h4>
<div class="ulist">
<ul>
<li>
<p>Centralized buffer management logic</p>
</li>
<li>
<p>Easier to add bounds checking</p>
</li>
<li>
<p>Less error-prone</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_consistency">1.4.3. Consistency</h4>
<div class="ulist">
<ul>
<li>
<p>Similar philosophy to LexemBuffer</p>
</li>
<li>
<p>Uniform API for lexem stream operations</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_strategy">1.5. Implementation Strategy</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Step 1: Add new fields to LexInput (backward compatible)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Initialize <code>allocatedSize = 0</code> and <code>ownsBuffer = false</code> for all existing uses</p>
</li>
<li>
<p>No functional changes yet</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Step 2: Create lexinput.c with basic API</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Implement core functions: create, ensure capacity, append, copy</p>
</li>
<li>
<p>Add unit tests</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Step 3: Refactor one function as proof of concept</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Start with <code>copyRemainingLexems()</code> (simplest)</p>
</li>
<li>
<p>Validate approach works</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Step 4: Refactor remaining functions</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Work through priority list</p>
</li>
<li>
<p>Update call sites incrementally</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Step 5: Cleanup</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Remove old helper functions if no longer needed</p>
</li>
<li>
<p>Update documentation</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_risks_and_mitigation">1.6. Risks and Mitigation</h3>
<div class="sect3">
<h4 id="_risk_breaking_existing_code">1.6.1. Risk: Breaking existing code</h4>
<div class="paragraph">
<p><strong>Mitigation:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make LexInput changes backward compatible</p>
</li>
<li>
<p>Add new fields with safe defaults</p>
</li>
<li>
<p>Refactor incrementally, one function at a time</p>
</li>
<li>
<p>Run full test suite after each change</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_risk_performance_regression">1.6.2. Risk: Performance regression</h4>
<div class="paragraph">
<p><strong>Mitigation:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep buffer operations inline where critical</p>
</li>
<li>
<p>Profile before/after</p>
</li>
<li>
<p>The current code already does realloc, just manually</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_risk_memory_leaks_from_ownsbuffer_confusion">1.6.3. Risk: Memory leaks from ownsBuffer confusion</h4>
<div class="paragraph">
<p><strong>Mitigation:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clear ownership semantics in documentation</p>
</li>
<li>
<p>Consider using explicit create/destroy pairs</p>
</li>
<li>
<p>Add assertions for debugging</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_notes">1.7. Notes</h3>
<div class="sect3">
<h4 id="_why_not_unify_with_lexembuffer">1.7.1. Why not unify with LexemBuffer?</h4>
<div class="paragraph">
<p>LexemBuffer and LexInput serve different purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>LexemBuffer</strong>: Heavy, file-oriented, owns fixed-size array, lots of metadata</p>
</li>
<li>
<p><strong>LexInput</strong>: Lightweight, flexible views, points to various sources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Trying to unify them would make both worse. The real issue is LexInput lacks manipulation functions, not that two types exist.</p>
</div>
</div>
<div class="sect3">
<h4 id="_backward_compatibility">1.7.2. Backward compatibility</h4>
<div class="paragraph">
<p>The proposed changes are designed to be backward compatible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New fields default to "not owned, size unknown" (0, false)</p>
</li>
<li>
<p>Existing code that creates LexInput with <code>makeLexInput()</code> continues to work</p>
</li>
<li>
<p>Only new code uses the enhanced API</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_open_questions">1.8. Open Questions</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Should <code>lexInputEnsureCapacity()</code> use ppmAlloc or mbmAlloc?</p>
<div class="ulist">
<ul>
<li>
<p>Probably depends on context - may need separate functions or a memory source parameter</p>
</li>
</ul>
</div>
</li>
<li>
<p>How to handle the transition from raw pointers to LexInput?</p>
<div class="ulist">
<ul>
<li>
<p>Some functions receive raw pointers from outside (e.g., from MacroBody.body)</p>
</li>
<li>
<p>May need wrapper functions to create temporary LexInput views</p>
</li>
</ul>
</div>
</li>
<li>
<p>Should we add debug assertions for bounds checking?</p>
<div class="ulist">
<ul>
<li>
<p>Would help catch errors during development</p>
</li>
<li>
<p>Could be compiled out in production</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_references">1.9. References</h3>
<div class="ulist">
<ul>
<li>
<p>Current code: <code>src/yylex.c</code> lines 1362-1823 (macro expansion)</p>
</li>
<li>
<p>LexemBuffer API: <code>src/lexembuffer.h</code> and <code>src/lexembuffer.c</code></p>
</li>
<li>
<p>Current LexInput: <code>src/input.h</code> and <code>src/input.c</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_issues">1.10. Related Issues</h3>
<div class="paragraph">
<p>This refactoring addresses the root cause identified in the discussion about replacing the malloc-based macro body memory system (commit e1d506f7). The memory tracking issues stem from the complexity of managing multiple pointer parameters across function boundaries.</p>
</div>
<hr>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When implementing this refactoring, consider starting with unit tests for the new API functions before refactoring existing code. This will help validate the design and provide safety during migration.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unified-symbol-database">2. Unified Symbol Database Architecture</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_problem_statement_2">2.1. Problem Statement</h3>
<div class="paragraph">
<p>The current symbol database has evolved from a batch cross-referencer (like <code>ctags</code>) with artificial distinctions between "file-based" and "on-demand" modes. This creates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Mode complexity</strong>: Different code paths for Emacs vs LSP clients</p>
</li>
<li>
<p><strong>Cold start problems</strong>: Requires upfront <code>-create</code> operation before use</p>
</li>
<li>
<p><strong>Manual updates</strong>: Users must remember to run <code>-update</code> after changes</p>
</li>
<li>
<p><strong>Inconsistent behavior</strong>: Different modes provide different guarantees</p>
</li>
<li>
<p><strong>Maintenance overhead</strong>: Multiple implementations to maintain and test</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_current_architecture_limitations">2.2. Current Architecture Limitations</h3>
<div class="paragraph">
<p>The existing system distinguishes between:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aspect</th>
<th class="tableblock halign-left valign-top">File-Based Mode</th>
<th class="tableblock halign-left valign-top">On-Demand Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cold Start</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires <code>-create</code> first</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parse file immediately</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Warm Queries</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O(1) hash lookup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O(file_size) parsing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory Usage</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low (streaming)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High (in-memory cache)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Incremental Updates</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart file tracking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per-file invalidation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Multi-project</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Separate databases</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Workspace-scoped</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_proposed_solution_2">2.3. Proposed Solution</h3>
<div class="sect3">
<h4 id="_core_insight_unified_on_demand_architecture">2.3.1. Core Insight: Unified On-Demand Architecture</h4>
<div class="paragraph">
<p>Both Emacs and LSP clients want the same thing: <strong>up-to-date symbol and reference information</strong>. The distinction between "file-based" and "on-demand" modes is artificial complexity. Instead, c-xrefactory should provide a unified interface that:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Always ensures information is current</strong> using existing dependency tracking</p>
</li>
<li>
<p><strong>Scans incrementally</strong> only what&#8217;s needed, when needed</p>
</li>
<li>
<p><strong>Uses <code>.cx</code> files as persistent cache</strong> for optimization</p>
</li>
<li>
<p><strong>Eliminates cold start problems</strong> by avoiding upfront full-project scanning</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_simplified_interface_design">2.3.2. Simplified Interface Design</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct SymbolDatabase SymbolDatabase;

typedef struct {
    // Unified operations for any client (Emacs or LSP)
    Symbol* (*lookupSymbol)(SymbolDatabase* db, const char* name, Position pos);
    ReferenceList* (*getReferences)(SymbolDatabase* db, const char* name, Position pos);
    ReferenceList* (*getOccurrences)(SymbolDatabase* db, const char* name, Position pos);

    // All complexity hidden in implementation:
    // - File modification checking (existing: checkFileModifiedTime)
    // - Include dependency tracking (existing: cachedIncludedFilePass)
    // - Incremental scanning (existing: makeIncludeClosureOfFilesToUpdate)
    // - Persistent caching (existing: .cx file system)
} SymbolDatabaseOperations;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_strategy_smart_on_demand">2.3.3. Implementation Strategy: Smart On-Demand</h4>
<div class="paragraph">
<p>The implementation leverages <strong>existing sophisticated logic</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">Symbol* lookupSymbol(const char* name, Position pos) {
    // 1. Check if cached information is up-to-date
    if (symbolInfoIsCurrent(name, pos)) {
        return getCachedSymbolInfo(name, pos);  // Use .cx files when valid
    }

    // 2. Use existing dependency tracking to scan minimal set
    FileList* filesToScan = calculateDependencyClosure(pos.file);
    for (FileItem* file : filesToScan) {
        if (!checkFileModifiedTime(file-&gt;fileNumber)) {
            scanFileAndUpdateCache(file);  // Incremental scan
        }
    }

    // 3. Update persistent cache for next time
    updateSymbolCache(name, pos);

    return getSymbolInfo(name, pos);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Key Benefits:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No artificial modes</strong> - same code path for all clients</p>
</li>
<li>
<p><strong>No cold start</strong> - first lookup triggers minimal necessary scanning</p>
</li>
<li>
<p><strong>Incremental by design</strong> - only scans files that need updating</p>
</li>
<li>
<p><strong>Persistent optimization</strong> - results cached in <code>.cx</code> files for next session</p>
</li>
<li>
<p><strong>Existing logic reuse</strong> - leverages proven dependency tracking system</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_legacy_architecture_recognition">2.3.4. Legacy Architecture Recognition</h4>
<div class="paragraph">
<p>c-xrefactory evolved from a <strong>batch cross-referencer</strong> (like <code>ctags</code>) and was enhanced for real-time use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Legacy batch workflow:
c-xref -create project.c     # Full scan, build .cx database
c-xref -update modified.c    # Incremental update
c-xref -olcxpush symbol      # Query pre-built database

# Unified approach:
c-xref -server               # Start server, scan on-demand as needed
c-xref -lsp                  # Same logic, different protocol</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>.cx</code> files are essentially a <strong>persistent cache</strong> of analysis results, not a fundamental requirement.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_plan">2.4. Implementation Plan</h3>
<div class="sect3">
<h4 id="_phase_1_interface_unification">2.4.1. Phase 1: Interface Unification</h4>
<div class="ulist">
<ul>
<li>
<p>Create unified <code>SymbolDatabase</code> interface</p>
</li>
<li>
<p>Wrap existing logic in smart on-demand implementation</p>
</li>
<li>
<p>Replace explicit <code>-create</code>/<code>-update</code> commands with automatic dependency checking</p>
</li>
<li>
<p>Both Emacs and LSP use same code path</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_phase_2_optimization">2.4.2. Phase 2: Optimization</h4>
<div class="ulist">
<ul>
<li>
<p>Enhance existing dependency tracking for finer-grained invalidation</p>
</li>
<li>
<p>Optimize in-memory caching strategies</p>
</li>
<li>
<p>Background <code>.cx</code> file maintenance for long-running sessions</p>
</li>
<li>
<p>Performance tuning for large codebases</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_benefits_2">2.5. Benefits</h3>
<div class="sect3">
<h4 id="_architectural_simplification">2.5.1. Architectural Simplification</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Single code path</strong> for both Emacs and LSP clients - eliminates maintenance overhead</p>
</li>
<li>
<p><strong>No mode distinctions</strong> - same smart logic serves all use cases optimally</p>
</li>
<li>
<p><strong>Leverages existing logic</strong> - reuses proven dependency tracking and caching systems</p>
</li>
<li>
<p><strong>Reduced complexity</strong> - eliminates artificial FILE_BASED/ON_DEMAND/HYBRID modes</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_user_experience_improvements">2.5.2. User Experience Improvements</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Zero configuration</strong> - works immediately on any C project without setup</p>
</li>
<li>
<p><strong>No cold start delay</strong> - first symbol lookup triggers minimal necessary scanning</p>
</li>
<li>
<p><strong>Transparent caching</strong> - <code>.cx</code> files automatically maintained as performance optimization</p>
</li>
<li>
<p><strong>Consistent behavior</strong> - same results whether using Emacs or modern IDE with LSP</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_performance_characteristics_2">2.5.3. Performance Characteristics</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Minimal initial cost</strong> - avoids expensive upfront full-project scanning</p>
</li>
<li>
<p><strong>Smart incremental updates</strong> - only rescans files that have actually changed</p>
</li>
<li>
<p><strong>Automatic dependency tracking</strong> - includes files affected by changes get updated</p>
</li>
<li>
<p><strong>Persistent optimization</strong> - analysis results cached across sessions</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_development_benefits">2.5.4. Development Benefits</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Backward compatibility</strong> - existing Emacs workflows continue unchanged</p>
</li>
<li>
<p><strong>Forward compatibility</strong> - natural path to modern LSP integration</p>
</li>
<li>
<p><strong>Reduced maintenance</strong> - single implementation instead of multiple modes</p>
</li>
<li>
<p><strong>Enhanced testability</strong> - unified logic easier to test comprehensively</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_existing_infrastructure">2.6. Existing Infrastructure</h3>
<div class="sect3">
<h4 id="_sophisticated_dependency_tracking">2.6.1. Sophisticated Dependency Tracking</h4>
<div class="paragraph">
<p>The unified approach leverages c-xrefactory&#8217;s <strong>existing sophisticated dependency management</strong> that handles include file relationships automatically:</p>
</div>
<div class="paragraph">
<p><strong>File Modification Tracking</strong> (<code>filetable.h</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct fileItem {
    char *name;
    time_t lastModified;        // Last known modification time
    time_t lastInspected;       // Last time we checked
    time_t lastUpdateMtime;     // Last update cycle time
    time_t lastFullUpdateMtime; // Last full update time
    // ... scheduling and state flags
} FileItem;

bool checkFileModifiedTime(int fileNumber);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Include Dependency Tracking</strong> (<code>yylex.c</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">void pushInclude(FILE *file, EditorBuffer *buffer, char *name, char *prepend) {
    // ... setup include stack
    includeStack.stack[includeStack.pointer++] = currentFile;
    // Track include relationships for dependency analysis
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Automatic Include Closure</strong> (<code>xref.c:81-108</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static void makeIncludeClosureOfFilesToUpdate(void) {
    // If file A includes file B, and B is modified, A gets scheduled for update
    // This uses the reference database to track include relationships
    bool fileAddedFlag = true;
    while (fileAddedFlag) {
        // Iterative closure: keeps adding dependent files until stable
        for (all scheduled files) {
            find_all_files_that_include_this_file();
            schedule_them_for_update();
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This dependency tracking infrastructure is <strong>already production-ready</strong> and handles the complex cases (transitive dependencies, modification time checking, include stack management). The unified symbol database can leverage this existing logic instead of reimplementing dependency management.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_open_questions_2">2.7. Open Questions</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Should we maintain backward compatibility with explicit <code>-create</code>/<code>-update</code> commands?</p>
<div class="ulist">
<ul>
<li>
<p>Probably yes, at least as no-ops or aliases to make transition easier</p>
</li>
</ul>
</div>
</li>
<li>
<p>How to handle very large projects (&gt;1M LOC)?</p>
<div class="ulist">
<ul>
<li>
<p>May need workspace-level configuration for incremental scanning thresholds</p>
</li>
<li>
<p>Consider lazy loading of symbol data</p>
</li>
</ul>
</div>
</li>
<li>
<p>What&#8217;s the migration path for existing users?</p>
<div class="ulist">
<ul>
<li>
<p>Existing <code>.cx</code> files should continue to work</p>
</li>
<li>
<p>Auto-migrate on first run with new version</p>
</li>
<li>
<p>Provide clear documentation on new behavior</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_references_2">2.8. References</h3>
<div class="ulist">
<ul>
<li>
<p>Current implementation: <code>src/cxfile.c</code>, <code>src/xref.c</code></p>
</li>
<li>
<p>File tracking: <code>src/filetable.h</code>, <code>src/filetable.c</code></p>
</li>
<li>
<p>Dependency tracking: <code>src/xref.c</code> lines 81-108</p>
</li>
<li>
<p>Current database description: See chapter 08 (Code) - Reference Database section</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_archive">3. Archive</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section you can find some descriptions and saved texts that
described how things were before. They are no longer true, since that
quirk, magic or bad coding is gone. But it is kept here as an archive
for those wanting to do backtracking to original sources.</p>
</div>
<div class="sect2">
<h3 id="_memory_strategies">3.1. Memory strategies</h3>
<div class="paragraph">
<p>There were a multitude of specialized memory allocation functions. In
principle there where two types, static and dynamic. The dynamic could
be exteded using a overflow handler.</p>
</div>
<div class="paragraph">
<p>Also one type had a struct where the actual area was extended beyond
the actual struct. This was very confusing&#8230;&#8203;</p>
</div>
<div class="sect3">
<h4 id="_static_memory_allocation">3.1.1. Static memory allocation</h4>
<div class="paragraph">
<p>Static memory (SM_ prefix) are static areas allocated by the compiler
which is then indexed using a similarly named index variable
(e.g. <code>ftMemory</code> and <code>ftMemoryIndex</code>), something the macros took
advantage of. These are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ftMemory</code></p>
</li>
<li>
<p><code>ppmMemory</code></p>
</li>
<li>
<p><code>mbMemory</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One special case of static memory also exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>stackMemory</code> - synchronous with program structure and has CodeBlock
markers, so there is a special <code>stackMemoryInit()</code> that initializes
the outermost CodeBlock</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These areas cannot be extended, when it overruns the program stops.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trivial_prechecks">3.2. Trivial Prechecks</h3>
<div class="paragraph">
<p>The refactorer can call the server using <code>parseBufferUsingServer()</code> and add some extra options (in text form).
One example is <code>setMovingPrecheckStandardEnvironment()</code> where it calls the server with <code>-olcxtrivialprecheck</code>.</p>
</div>
<div class="paragraph">
<p>However <code>parseBufferUsingServer()</code> uses <code>callServer()</code> which never <code>answerEditAction()</code>.</p>
</div>
<div class="paragraph">
<p>In <code>answerEditAction()</code> the call to (unused) <code>olTrivialRefactoringPreCheck()</code> also requires an <code>options.trivialPreCheckCode</code> which is neither send by <code>setMovingPrecheckStandardEnvironment()</code> nor parsed by <code>processOptions()</code>.</p>
</div>
<div class="paragraph">
<p>The only guess I have is that previously all prechecks where handled by the <code>-olcxtrivialprecheck</code> option in calls to the server, and have now moved to their respective refactorings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This theory should be checked by looking at the original source of the precheck functions and compare that with any possible checks in the corresponding refactoring code.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_huge_memory">3.3. HUGE Memory</h3>
<div class="paragraph">
<p>Previously a HUGE model was also available (by re-compilation) to
reach file numbers, lines and columns above 22 bits. But if you have
more than 4 million lines (or columns!) you should probably do
something radical before attempting cross referencing and refactoring.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bootstrapping">3.4. Bootstrapping</h3>
<div class="sect3">
<h4 id="_bootstrap_removed">3.4.1. BOOTSTRAP REMOVED!</h4>
<div class="paragraph">
<p>Once the FILL-macros was removed, we could move the enum-generation to
use the actual <code>c-xref</code>. So from now on we build <code>c-xref</code> directly
from the sources in the repo. Changes to any enums will trigger a
re-generation of the enumTxt-files but since the enumTxt-files are
only conversion of enum values to strings any mismatch will not
prevent compilation, and it would even be possible to a manual
update. This is a big improvement over the previous situation!</p>
</div>
</div>
<div class="sect3">
<h4 id="_fills_removed">3.4.2. FILLs REMOVED!</h4>
<div class="paragraph">
<p>As indicated in <a href="#_fill_macros">FILL macros</a> the bootstrapping of FILL-macros has
finally and fully been removed.</p>
</div>
<div class="paragraph">
<p>Gone is also the <code>compiler_defines.h</code>, which was just removed without
any obvious adverse effects.  Maybe that will come back and bite me
when we move to more platforms other than linux and MacOS&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Left is, at this point, only the <code>enumTxt</code> generation, so most of the
text below is kept for historical reasons.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rationale">3.4.3. Rationale</h4>
<div class="paragraph">
<p><em>c-xref</em> uses a load of structures, and lists of them, that need to be
created and initialized in a lot of places (such as the parsers). To
make this somewhat manageable, <em>c-xref</em> itself parses the strucures
and generates macros that can be used to fill them with one call.</p>
</div>
<div class="paragraph">
<p><em>c-xref</em> is also bootstrapped into reading in a lot of predefined
header files to get system definitions as "preloaded
definitions".</p>
</div>
<div class="paragraph">
<p>Why this pre-loading was necessary, I don&#8217;t exactly know. It
might be an optimization, or an idea that was born early and then just
kept on and on. In any case it creates an extra complexity
building and maintaining and to the structure of <em>c-xref</em>.</p>
</div>
<div class="paragraph">
<p>So this must be removed, see below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mechanism">3.4.4. Mechanism</h4>
<div class="paragraph">
<p>The bootstrapping uses <em>c-xref</em>'s own capability to parse C-code and
parse those structures and spit out filling macros, and some other
stuff.</p>
</div>
<div class="paragraph">
<p>This is done using options like `-task_regime_generate' which prints a
lot of data structures on the standard output which is then fed into
generated versions of <em>strFill</em>, <em>strTdef</em>(no longer exists) and
<em>enumTxt</em> by the Makefile.</p>
</div>
<div class="paragraph">
<p>The process starts with building a <em>c-xref.bs</em> executable from checked
in sources. This compile uses a BOOTSTRAP define that causes some
header files to include pre-generated versions of the generated files
(currently <em>strFill.bs.h</em> and <em>enumTxt.bs.h</em>) which should work in all
environments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if you change the name of a field in a structure that is subject
to FILL-generation you will need to manually update the
<em>strFill.bs.h</em>, but a "make cleaner all" will show you where those are.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After the <em>c-xref.bs</em> has been built, it is used to generate <em>strFill</em>
and <em>enumTxt</em> which might include specific structures for the current
environment.</p>
</div>
<div class="paragraph">
<p>HOWEVER: if FILL macros are used for structures which are different on
some platforms, say a FILE structure, that FILL macro will have
difference number of arguments, so I&#8217;m not sure how smart this "smart"
generation technique actually is.</p>
</div>
<div class="paragraph">
<p>TODO: Investigate alternative approaches to this generate "regime",
perhaps move to a "class"-oriented structure with initialization
functions for each "class" instead of macros.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_defines">3.4.5. Compiler defines</h4>
<div class="paragraph">
<p>In <em>options.h</em> there are a number of definitions which somehow are
sent to the compiler/preprocessor or used so that standard settings
are the same as if a program will be compiled using the standard
compiler on the platform. At this point I don&#8217;t know exactly how this
conversion from C declarations to compile time definitions is done,
maybe just entered as symbols in one of the many symboltables?</p>
</div>
<div class="paragraph">
<p>Typical examples include "__linux" but also on some platforms things
like "fpos_t=long".</p>
</div>
<div class="paragraph">
<p>I&#8217;ve implemented a mechanism that uses "gcc -E -mD" to print out and
catch all compiler defines in <code>compiler_defines.h</code>. This was necessary
because of such definitions on Darwin which where not in the
"pre-programmed" ones.</p>
</div>
<div class="paragraph">
<p>TODO?: As this is a more general approach it should possibly
completely replace the "programmed" ones in <code>options.c</code>?</p>
</div>
</div>
<div class="sect3">
<h4 id="_enumtxt_generation_removed">3.4.6. EnumTxt generation REMOVED!</h4>
<div class="paragraph">
<p>To be able to print the string values of enums the module generate.c
(called when regime was RegimeGenerate) could also generate string
arrays for all enums. By replacing that with some pre-processor magic
for the few that was actually needed (mostly in log_trace() calls) we
could do away with that whole "generate" functionality too.</p>
</div>
<div class="paragraph">
<p>(Last commit with enum generation intact is <a href="https://github.com/thoni56/c-xrefactory/commit/aafd7b1f813f2c17c684ea87ac87a0be31cdd4c4" class="bare">https://github.com/thoni56/c-xrefactory/commit/aafd7b1f813f2c17c684ea87ac87a0be31cdd4c4</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_enumtxt">3.4.7. enumTxt</h4>
<div class="paragraph">
<p>For some cases the string representing the value of an Enum is needed.
<code>c-xref</code> handles this using the "usual" 'parse code and generate' method.
The module <code>generate.c</code> does this generation too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_include_paths">3.4.8. Include paths</h4>
<div class="paragraph">
<p>Also in <em>options.h</em> some standard-like include paths are added, but
there is a better attempt in <em>getAndProcessGccOptions()</em> which uses
the compiler/preprocessor itself to figure out those paths.</p>
</div>
<div class="paragraph">
<p>TODO?: This is much better and should really be the only way, I think.</p>
</div>
</div>
<div class="sect3">
<h4 id="_problems">3.4.9. Problems</h4>
<div class="paragraph">
<p>Since at bootstrap there must exist FILL-macros with the correct field
names this strategy is an obstacle to cleaning up the code since every
field is referenced in the FILL macros. When a field (in a structure
which <strong>are</strong> filled using the FILL macro) changes name, this will make
initial compilation impossible until the names of that field is also
changed in the <code>strFill.bs.h</code> file.</p>
</div>
<div class="paragraph">
<p>One way to handle this is of course to use <code>c-xrefactory</code> itself and
rename fields. This requires that the project settings also include a
pass with BOOTSTRAP set, which it does.</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing">3.4.10. Removing</h4>
<div class="paragraph">
<p>I&#8217;ve started removing this step. In TODO.org I keep a hierarchical list
of the actions to take (in a Mikado kind of style).</p>
</div>
<div class="paragraph">
<p>The basic strategy is to start with structures that no other structure
depends on. Using the script <code>utils/struct2dot.py</code> you can generate a
DOT graph that shows those dependencies.</p>
</div>
<div class="paragraph">
<p>Removal can be done in a couple of ways</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If it&#8217;s a very small structure you can replace a call to a <code>FILL_XXX()</code> macro
with a <a href="https://gcc.gnu.org/onlinedocs/gcc/Compound-Literals.html">compound literal</a>.</p>
</li>
<li>
<p>A better approach is usually to replace it with a <code>fillXXX()</code> function, or even
better, with a <code>newXXX()</code>, if it consistently is preceeded with an allocation
(in the same memory!). To see what fields vary you can grep all such calls, make a
CSV-file from that, and compare all rows.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_strtdef_h">3.4.11. strTdef.h</h4>
<div class="paragraph">
<p>The <code>strTdef.h</code> was generated using the option <code>-typedefs</code> as a part
of the old <code>-task_regime_generate</code> strategy and generated typedef
declarations for all types found in the parsed files.</p>
</div>
<div class="paragraph">
<p>I also think that you could actually merge the struct definition with
the typedef so that <em>strTdef.h</em> would not be needed. But it seems that
this design is because the structures in <em>proto.h</em> are not a directed
graph, so loops makes that impossible. Instead the typedefs are
included before the structs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#include "strTdef.h"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>struct someNode {
    S_someOtherNode *this;
    ...</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>struct someOtherNode {
    S_someNode *that;
    ...</pre>
</div>
</div>
<div class="paragraph">
<p>This is now ideomatically solved using the structs themselves:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>struct someNode {
    struct someOtherNode *this;
    ...</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>struct someOtherNode {
    struct someNode *that;
    ...</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fill_macros">3.5. FILL macros</h3>
<div class="paragraph">
<p><em><strong>The FILL macros are now fully replaced by native functions or some other,</strong></em>
<em><strong>more refactoring-friendly, mechanism. Yeah!</strong></em>***</p>
</div>
<div class="paragraph">
<p>During bootstrapping a large number of macros named <em>__FILL_xxxx</em> is
created. The intent is that you can fill a complete structure with one
call, somewhat like a constructor, but here it&#8217;s used more generally
every time a complex struct needs to be initialized.</p>
</div>
<div class="paragraph">
<p>There are even <em>_FILLF_xxx</em> macros which allows filling fields in
sub-structures at the same time.</p>
</div>
<div class="paragraph">
<p>This is, in my mind, another catastrophic hack that makes
understanding, and refactoring, <code>c-xrefactory</code> such a pain. Not to
mention the extra bootstrap step.</p>
</div>
<div class="paragraph">
<p>I just discovered the compound literals of C99. And I&#8217;ll experiment
with replacing some of the FILL macros with compound literals assignments
instead.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>FILL_symbolList(memb, pdd, NULL);</pre>
</div>
</div>
<div class="paragraph">
<p>could become (I think):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>memb = (SymbolList){.d = pdd, .next = NULL};</pre>
</div>
</div>
<div class="paragraph">
<p>If successful, it would be much better, since we could probably get
rid of the bootstrap, but primarily it would be more explicit about
which fields are actually necessary to set.</p>
</div>
</div>
<div class="sect2">
<h3 id="_caching_module">3.6. Caching Module</h3>
<div class="paragraph">
<p><strong>The caching module described below has been archived as it is no longer part of the current architecture.</strong></p>
</div>
<div class="paragraph">
<p>The caching module was part of the memory management strategy when memory was scarce. It allowed
the system to detect out-of-memory situations, discard, flush and re-use memory during file processing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_caching_system_architecture">3.7. Caching System Architecture</h3>
<div class="paragraph">
<p><strong>The caching system described below has been archived as it is no longer part of the current architecture.</strong></p>
</div>
<div class="paragraph">
<p>The c-xrefactory included a sophisticated caching system that enabled incremental parsing by caching parsed input streams, parser state, and file modification tracking. This optimization allowed for faster re-analysis when only portions of source files had changed.</p>
</div>
<div class="sect3">
<h4 id="_core_design_principles">3.7.1. Core Design Principles</h4>
<div class="paragraph">
<p><strong>Cache Point Model</strong>: The system placed strategic snapshots of parser state at external definition boundaries (functions, global variables, etc.). When files were re-processed, the system could validate cache integrity, recover from cache points, and resume parsing only from the first changed definition onward.</p>
</div>
<div class="paragraph">
<p><strong>Separation of Concerns</strong>: Recent refactoring had separated file tracking from cache validation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>updateFileModificationTracking()</code> - Updated file timestamps without side effects</p>
</li>
<li>
<p><code>isFileModifiedSinceCached()</code> - Pure validation function for cache integrity</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_key_components">3.7.2. Key Components</h4>
<div class="paragraph">
<p><strong>Cache Point Management</strong> (<code>caching.c</code>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>placeCachePoint(bool)</code> - Placed strategic parser state snapshots</p>
</li>
<li>
<p><code>recoverFromCache()</code> - Restored parser state from cache points</p>
</li>
<li>
<p><code>recoverCachePointZero()</code> - Reset to initial cache state</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>File Modification Tracking</strong>:</p>
</div>
<div class="paragraph">
<p>The <code>FileItem</code> structure maintained multiple timestamp fields for tracking file modification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">struct FileItem {
    time_t lastModified;    // File's actual modification time
    time_t lastInspected;   // When we last checked the file
    // ... other fields
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Input Stream Caching</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cacheInput()</code> - Cached tokenized input from lexer</p>
</li>
<li>
<p><code>cachingIsActive()</code> - Checked if caching was currently enabled</p>
</li>
<li>
<p><code>activateCaching()</code> / <code>deactivateCaching()</code> - Controlled caching state</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_parser_integration">3.7.3. Parser Integration</h4>
<div class="paragraph">
<p><strong>C Parser Integration</strong>: Both C and Yacc parsers placed cache points after each <code>external_definition</code>, but only when not processing include files (<code>includeStack.pointer == 0</code>).</p>
</div>
<div class="paragraph">
<p><strong>Parser-Specific Behavior</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>C Parser</strong>: Full caching enabled with regular cache point placement</p>
</li>
<li>
<p><strong>Yacc Parser</strong>: Explicitly deactivated caching via <code>deactivateCaching()</code> but still placed strategic cache points</p>
</li>
<li>
<p><strong>Include Files</strong>: Cache points skipped during include processing</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_system_dependencies">3.7.4. System Dependencies</h4>
<div class="paragraph">
<p>The caching system was deeply integrated throughout the parsing pipeline:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Functions Used</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>main.c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initCaching()</code>, <code>activateCaching()</code>, <code>recoverCachePointZero()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifecycle control</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lexer.c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cacheInput()</code>, <code>cachingIsActive()</code>, <code>deactivateCaching()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input processing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>yylex.c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updateFileModificationTracking()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File tracking</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filetable.c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updateFileModificationTracking()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File management</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>xref.c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recoverFromCache()</code>, recovery functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cross-reference coordination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>c_parser.y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>placeCachePoint()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C grammar integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>yacc_parser.y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deactivateCaching()</code>, <code>placeCachePoint()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yacc grammar integration</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_performance_characteristics_3">3.7.5. Performance Characteristics</h4>
<div class="paragraph">
<p><strong>Cache Hit Scenarios</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Full Cache Hit</strong>: No file modifications since last parse - parser state recovered from cache point zero with minimal re-processing</p>
</li>
<li>
<p><strong>Partial Cache Hit</strong>: File modified after Nth definition - recovery from cache point N with re-parsing only from point of change onward</p>
</li>
<li>
<p><strong>Cache Miss</strong>: File structure changed or timestamps invalid - full re-parse with new cache points placed</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Optimization Benefits</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Memory usage scales with number of definitions, not file size</p>
</li>
<li>
<p>File modification checking minimizes unnecessary re-reads</p>
</li>
<li>
<p>Input stream caching reduces lexer overhead</p>
</li>
<li>
<p>Strategic cache point placement enables clean recovery at definition boundaries</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_users">3.8. Users</h3>
<div class="paragraph">
<p><strong>The <code>-user</code> option has now been removed, both in the tool and the
  editor adaptors, and with it one instance of a hashlist, the
  <code>olcxTab</code>, which now is a single structure, the <code>sessionData</code>.</strong></p>
</div>
<div class="paragraph">
<p>There is an option called <code>-user</code> which Emacs sets to the frame-id. To
me that indicates that the concept is that for each frame you create
you get a different "user" with the <code>c-xref</code> server that you (Emacs)
created.</p>
</div>
<div class="paragraph">
<p>The jedit adapter seems to do something similar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>options.add("-user");
Options.add(s.getViewParameter(data.viewId));</pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the sources to find when the function
<code>olcxSetCurrentUser()</code> is called it seems that you could have
different completion, refactorings, etc. going on at the same time in
different frames.</p>
</div>
<div class="paragraph">
<p>Completions etc. requires user interaction so they are not controlled
by the editor in itself only. At first glance though, the editor
(Emacs) seems to block multiple refactorings and referencs maintenance
tasks running at the same time.</p>
</div>
<div class="paragraph">
<p>This leaves just a few use cases for multiple "users", and I think it
adds unnecessary complexity. Going for a more "one user" approach,
like the model in the language server protocol, this could really be
removed.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-31 09:33:03 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>