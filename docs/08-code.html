<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>Code</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_code">Code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_passes">Passes</h3>
<div class="paragraph">
<p>There is a variable in <code>main()</code> called <code>firstPassing</code> which is set and passed
down through <code>mainEditServer()</code> until it is reset in
<code>mainFileProcessingInitialisations()</code> after <code>initCaching()</code>.</p>
</div>
<div class="paragraph">
<p>This is probably connected to the fact that <code>c-xref</code> allows for passing
over the analyzed source multiple passes in case you compile the
project sources with different C defines. Variables in the <code>c-xref</code>
sources indicate this, e.g the loops in <code>mainEditServerProcessFile()</code>
and <code>mainXrefProcessInputFile()</code> (which are both strangely limited by
setting the maxPass variable to 1 before entering the loop&#8230;&#8203;).</p>
</div>
</div>
<div class="sect2">
<h3 id="_parsers">Parsers</h3>
<div class="paragraph">
<p><em>C-xref</em> uses a patched version of Berkley yacc to generate
parsers. There are a number of parsers</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C</p>
</li>
<li>
<p>Yacc</p>
</li>
<li>
<p>C expressions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are also small traces of calls to the C++ parser that existed
but was proprietary.</p>
</div>
<div class="paragraph">
<p>The patch to byacc is mainly to the skeleton and seems to relate
mostly to handling of errors and adding a recursive parsing feature
that is required for Java, which was supported previously. It is not
impossible that this patch might not be necessary now that Java parsing
is not necessary, but this has not been tried.</p>
</div>
<div class="paragraph">
<p>Some changes are also made to be able to accomodate multiple parsers
in the same executable. The Makefile generates the parsers and renames
them as appropriate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_and_the_parsers">Refactoring and the parsers</h3>
<div class="paragraph">
<p>Some refactorings need more detailed information about the code, maybe all do?</p>
</div>
<div class="paragraph">
<p>One example, at least, is parameter manipulation.  Then the refactorer
calls the appropriate parser (<code>serverEditParseBuffer()</code>) which
collects information in the corresponding semantic actions.  This
information is stored in various global variables, like
<code>parameterBeginPosition</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
At this point I don&#8217;t understand exactly how this interaction is
performed, nor if the whole file is parsed or if there is some way to
just parse appropriate parts.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Findings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>some global variables are set as a result of command line
and arguments parsing, depending on which "command" the server is
acting on</p>
</li>
<li>
<p>the semantic rules in the parser(s) contains code that matches these
global variables and then inserts special lexems in the lexem stream</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One example is how a Java 'move static method' is performed. It
requires a target position. That position is transferred from command
line options to global variables. When the Java parser is parsing a
class or similar it (or rather the lexer) looks at that "target
position information" and inserts a <code>OL_MARKER_TOKEN</code> in the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO: What extra "operation" the parsing should perform and return
data for should be packaged into some type of "command" or parameter
object that should be passed to the parser, rather than relying on
global variables.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_reading_files">Reading Files</h3>
<div class="paragraph">
<p>Here are some speculations about how the complex file reading is structured.</p>
</div>
<div class="paragraph">
<p>Each file is identified by a filenumber, which is an index into the
file table, and seems to have a <code>lexBuffer</code> tied to it so that you can
just continue from where ever you were. That in turn contains a
<code>CharacterBuffer</code> that handles the actual character reading.</p>
</div>
<div class="paragraph">
<p>And there is also an "editorBuffer"&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The intricate interactions between these are hard to follow as the code
here are littered with short character names which are copies of fields
in the structures, and infested with many macros, probably in an ignorant
attempt at optimizing. ("The root of all evil is premature optimization" and
"Make it work, make it right, make it fast".)</p>
</div>
<div class="paragraph">
<p>It seems to all start in <code>initInput()</code> in <code>yylex.c</code> where the only
call to <code>fillFileDescriptor()</code> is made. But you might wonder why this
function does some initial reading, this should be pushed down to the
buffers in the file descriptor.</p>
</div>
<div class="sect3">
<h4 id="_lexingscanning">Lexing/scanning</h4>
<div class="paragraph">
<p>Lexing/scanning is performed in two layers, one in <code>lexer.c</code> which
seems to be doing the actual lexing into lexems which are put in a
lexembuffer. This contains a sequence of encoded and compressed
symbols which first has a <code>LexemCode</code> which is followed by extra data,
like <code>Position</code>. These seems to always be added but not always necessary.</p>
</div>
<div class="paragraph">
<p>The higher level "scanning" is performed, as per ususal,
by <code>yylex.c</code>. <code>lexembuffer</code> defines some functions to put and get
lexems, chars (identifiers and file names?) as well as integers and
positions.</p>
</div>
<div class="paragraph">
<p>At this point the put/get lexem functions take a pointer to a pointer
to chars (which presumably is the lexem stream in the lexembuffer)
which it also advances. This requires the caller to manage the
LexemBuffer&#8217;s internal pointers outside and finally set them right
when done.</p>
</div>
<div class="paragraph">
<p>It would be much better to call the "putLexem()"-functions with a
lexemBuffer but there seems to be a few cases where the destination
(often <code>dd</code>) is not a lexem stream inside a lexemBuffer.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is a work-in-progress.
Currently most of the "normal" usages are prepared to use the LexemBuffer&#8217;s pointers.
But the handling of macros and defines are cases where the lexems are not put in a LexemBuffer.
See the TODO.org for current status of this Mikado sequence.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_semantic_information">Semantic information</h4>
<div class="paragraph">
<p>As the refactoring functions need some amount of semantic information,
in the sense of information gathered during parsing, this information
is collected in various ways when <code>c-xref</code> calls the "sub-task" to do
the parsing required.</p>
</div>
<div class="paragraph">
<p>Two structures hold information about various things, among which are
the memory index at certain points of the parsing. Thus it is possible
to verify e.g. that a editor region does not cover a break in block or
function structure. These structures are, at the point of writing,
called <code>parsedInfo</code> and <code>parsedClassInfo</code>, and they definitely need to
be tidied up.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reference_database">Reference Database</h3>
<div class="paragraph">
<p><code>c-xref</code> creates a database of references for all symbols it encounters. There is limited
support to automatically update these in the edit-compile cycle, you might have to
update manually now and then.</p>
</div>
<div class="paragraph">
<p>The project settings (or command line options) indicate where the file(s) are created
and one option controls the number of files to be used, <code>-refnum</code>.</p>
</div>
<div class="paragraph">
<p>This file (or files) contains compact, but textual representations of
the cross-reference information. Format is somewhat complex, but here
are somethings that I think I have found out:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the encoding has one character markers which are listed at the top
of cxfile.c</p>
</li>
<li>
<p>the coding seems to often start with a number and then a character,
such as '4l' (4 ell) means line 4, 23c mean column 23</p>
</li>
<li>
<p>references seems to be optimized to not repeat information if it
would be a repetition, such as '15l3cr7cr' means that there are two
references on line 15, one in column 3 the other in column 7</p>
</li>
<li>
<p>so there is a notion of "current" for all values which need not be
repeated</p>
</li>
<li>
<p>e.g. references all use 'fsulc' fields, i.e. file, symbol index,
usage, line and column, but do not repeat a 'fsulc' as long as it is
the same</p>
</li>
<li>
<p>some "fields" have a length indicator before, such as filenames
('6:/abc.c') indicated by ':' and version information ('34v file
format: C-xrefactory 1.6.0 ') indicated by 'v'.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So a line might say</p>
</div>
<div class="literalblock">
<div class="content">
<pre>12205f 1522108169p m1ia 84:/home/...</pre>
</div>
</div>
<div class="paragraph">
<p>The line identifies the file with id 12205. The file was last included
in an update of refs at sometime which is identified by 1522108169
(mtime), has not been part of a full update of xrefs, was mentioned on
the command line. (I don&#8217;t know what the 'a' means&#8230;&#8203;) Finally, the
file name itself is 84 characters long.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO: Build a tool to decipher this so that tests can query the
generated data for expected data. This is now partly ongoing in the
'utils' directory.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_editor_interface">Editor Interface</h3>
<div class="paragraph">
<p>I&#8217;ve been focusing on the Emacs interface since <code>Jedit</code> is not so
popular anymore and I&#8217;m an Emacs-guy.</p>
</div>
<div class="paragraph">
<p>Basically Emacs (and probably other editors) starts <code>c-xref</code> in
"server-mode" using <code>-server</code> which connects the editor
with <code>c-xref</code> through stdout/stdin. If you have <code>(setq
c-xref-debug-mode t)</code> this command is logged in the <code>*Messages*</code> buffer
with the prefix "calling:".</p>
</div>
<div class="paragraph">
<p>Commands are sent from the editor to the server on its standard input.
They looks very much like normal command line options, and in fact
<code>c-xref</code> will parse that input in the same way using the same
code. When the editor sends an <code>end-of-options</code> line, the server will
start executing whatever was sent, and return some information in the
file given as an <code>-o</code> option when the editor starts the <code>c-xref</code>
server process. The file is named and created by the editor and
usually resides in <code>/tmp</code>. With <code>c-xref-debug-mode</code> set to on this is
logged as "sending:". If you <code>(setq c-xref-debug-preserve-tmp-files
t)</code> Emacs will also not delete the temporary files it creates so that
you can inspect them afterwards.</p>
</div>
<div class="paragraph">
<p>When the server has finished processing the command and placed the
output in the output file it sends a <code>&lt;sync&gt;</code> reply.</p>
</div>
<div class="paragraph">
<p>The editor can then pick up the result from the output file and do
what it needs to do with it ("dispatching:").</p>
</div>
<div class="sect3">
<h4 id="_invocations">Invocations</h4>
<div class="paragraph">
<p>The editor invokes a new <code>c-xref</code> process for the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Refactoring</p>
<div class="paragraph">
<p>Each refactoring operation calls a new instance of <code>c-xref</code>.</p>
</div>
</li>
<li>
<p>Create Project</p>
<div class="paragraph">
<p>When a <code>c-xref</code> function is executed in the editor and there is no
project covering that file, an interactive "create project" session is
started, which is run by a separate <code>c-xref</code> process.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_buffers">Buffers</h4>
<div class="paragraph">
<p>There is some magical editor buffer management happening inside of
<code>c-xref</code> which is not clear to me at this point. Basically it looks
like the editor-side tries to keep the server in sync with which
buffers are opened with what file&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>At this point I suspect that <code>-preload &lt;file1&gt; &lt;file2&gt;</code> means that the
editor has saved a copy <code>&lt;file1&gt;</code> in <code>&lt;file2&gt;</code> and requests the server
to set up a "buffer" describing that file and use it instead of the
<code>&lt;file1&gt;</code> that recides on disk.</p>
</div>
<div class="paragraph">
<p>This is essential when doing refactoring since the version of the file
most likely only exists in the editor, so the editor has to tell the
server the current content somehow, this is the <code>-preload</code> option.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_editor_server">Editor Server</h3>
<div class="paragraph">
<p>When serving an editor the c-xrefactory application is divided into
the server, <em>c-xref</em> and the editor part, at this point only Emacs:en
are supported so that&#8217;s implemented in the
<code>editor/Emacs</code>-packages. (The jEdit source is now also resurrected,
but it is completely untested and probably will be. It is resurrected
so that it can be inspected when investigating use of various server
options and features.)</p>
</div>
<div class="sect3">
<h4 id="_interaction">Interaction</h4>
<div class="paragraph">
<p>The initial invocation of the edit server creates a process with which
communication is over stdin/stdout using a protocol which from the editor
is basically a version of the command line options.</p>
</div>
<div class="paragraph">
<p>When the editor has delivered all information to the server it sends
'end-of-option' as a command and the edit server processes whatever it
has and responds with <code>&lt;sync&gt;</code> which means that the editor can fetch
the result in the file it named as the output file using the '-o'
option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As long as the communication between the editor and the server
is open, the same output file will be used. This makes it hard to
catch some interactions, since an editor operation might result in
multiple interactions, and the output file is then re-used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Setting the emacs variable <code>c-xref-debug-mode</code> forces the editor to
copy the content of such an output file to a separate temporary file
before re-using it.</p>
</div>
<div class="paragraph">
<p>For some interactions the editor starts a completely new and fresh
<code>c-xref</code> process, see below. And actually you can&#8217;t do refactorings
using the server, they have to be separate calls. (Yes?) I have yet to
discover why this design choice was made.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There are many things in the sources that handles refactorings
separately, such as <code>refactoring_options</code>, which is a separate copy of
the options structure used only when refactoring.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_protocol">Protocol</h4>
<div class="paragraph">
<p>Communication between the editor and the server is performed using
text through standard input/output to/from <em>c-xref</em>. The protocol is
defined in src/protocol.tc and must match <code>editor/emacs/c-xrefprotocol.el</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the protocol only caters for the server&#8594;editor part,
the editor&#8594;server part consists of command lines resembling the command
line options and arguments, and actually is handled by the same code.</p>
</div>
<div class="paragraph">
<p>The file <code>protocol.tc</code> is included in <code>protocol.h</code> and <code>protocol.c</code>
which generates definitions and declarations for the elements through
using some macros.</p>
</div>
<div class="paragraph">
<p>There is a similar structure with <em>c-xrefprotocol.elt</em> which
includes <em>protocol.tc</em> to wrap the PROTOCOL_ITEMs into
<code>defvar</code>s.</p>
</div>
<div class="paragraph">
<p>There is also some Makefile trickery that ensures that the C and elisp
impementations are in sync.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_of_server">Invocation of server</h4>
<div class="paragraph">
<p>The editor fires up a server and keeps talking over the established
channel (elisp function 'c-xref-start-server-process'). This probably
puts extra demands on the memory management in the server, since it
might need to handle multiple information sets and options (as read
from a .cxrefrc-file) for multiple projects simultaneously over a
longer period of time. (E.g. if the user enters the editor starting
with one project and then continues to work on another then new
project options need to be read, and new reference information be
generated, read and cached.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO: Figure out and describe how this works by looking at the
elisp-sources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>FINDINGS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>c-xref-start-server-process in c-xref.el</p>
</li>
<li>
<p>c-xref-send-data-to-running-process in c-xref.el</p>
</li>
<li>
<p>c-xref-server-call-refactoring-task in c-xref.el</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_communication_protocol">Communication Protocol</h4>
<div class="paragraph">
<p>The editor server is started using the appropriate command line option
and then it keeps the communication over stdin/stdout open.</p>
</div>
<div class="paragraph">
<p>The editor part sends command line options to the server, which looks
something like (from the read_xrefs test case):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>-encoding=european -olcxpush -urldirect  "-preload" "&lt;file&gt;" "-olmark=0" "-olcursor=6" "&lt;file&gt;" -xrefrc ".c-xrefrc" -p "&lt;project&gt;"
end-of-options</pre>
</div>
</div>
<div class="paragraph">
<p>In this case the "-olcxpush" is the operative command which results in
the following output</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;goto&gt;
 &lt;position-lc line=1 col=4 len=66&gt;CURDIR/single_int1.c&lt;/position-lc&gt;
&lt;/goto&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>As we can see from this interaction, the server will handle (all?)
input as a command line and manage the options as if it was a command
line invocation.</p>
</div>
<div class="paragraph">
<p>This explains the intricate interactions between the main program and
the option handling.</p>
</div>
<div class="paragraph">
<p>The reason behind this might be that a user of the editor might be
editing files on multiple projects at once, so every
interrogation/operation needs to clearly set the context of that
operation, which is what a user would do with the command line
options.</p>
</div>
</div>
<div class="sect3">
<h4 id="_olcx_naming">OLCX Naming</h4>
<div class="paragraph">
<p>It seems that all on-line editing server functions have an <code>olcx</code>
prefix, "On-Line C-Xrefactory", maybe&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring">Refactoring</h3>
<div class="paragraph">
<p>This is of course, the core in why I want to restore this, to get at its refactoring capabilities. So far, much is not understood, but here are some bits and pieces.</p>
</div>
<div class="sect3">
<h4 id="_editor_interface_2">Editor interface</h4>
<div class="paragraph">
<p>One thing that really confused me in the beginning was that the editor, primarily Emacs, don&#8217;t use the actual server that it has started for refactoring operations (and perhaps for other things also?). Instead it creates a separate instance with which it talks to about one refactoring.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve just managed to create the first automatic test for refactorings, <code>olcx_refactory_rename</code>. It was created by running the sandboxed emacs to record the communication and thus finding the commands to use.</p>
</div>
<div class="paragraph">
<p>Based on this learning it seems that a refactoring typically is a single invocation of <code>c-xref</code> with appropriate arguments (start &amp; stop markers, the operation, and so on) and the server then answers with a sequence of operations, like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;goto&gt;
 &lt;position-off off=3 len=&lt;n&gt;&gt;CURDIR/test_source/single_int1.c&lt;/position-off&gt;
&lt;/goto&gt;
&lt;precheck len=&lt;n&gt;&gt; single_int_on_line_1_col_4;&lt;/precheck&gt;
&lt;replacement&gt;
 &lt;str len=&lt;n&gt;&gt;single_int_on_line_1_col_4&lt;/str&gt;  &lt;str len=&lt;n&gt;&gt;single_int_on_line_1_col_44&lt;/str&gt;
&lt;/replacement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interactions">Interactions</h4>
<div class="paragraph">
<p>I haven&#8217;t investigated the internal flow of such a sequence, but it is starting to look like <code>c-xref</code> is internally re-reading the initialization, I&#8217;m not at this point sure what this means, I hope it&#8217;s not internal recursion&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_extraction">Extraction</h4>
<div class="paragraph">
<p>Each type of refactoring has it&#8217;s own little "language". E.g. extracting a method/function using <code>-refactory -rfct-extract-function</code> will return something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;extraction-dialog type=newFunction_&gt; &lt;str len=20&gt;	newFunction_(str);
&lt;/str&gt;
 &lt;str len=39&gt;static void newFunction_(char str[]) {
&lt;/str&gt;
 &lt;str len=3&gt;}

&lt;/str&gt;
  &lt;int val=2 len=0&gt;&lt;/int&gt;
&lt;/extraction-dialog&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So there is much logic in the editor for this. I suspect that the three <code>&lt;str&gt;</code> parts are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>what to replace the current region with</p>
</li>
<li>
<p>what to place before the current region</p>
</li>
<li>
<p>what to place after the current region</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this is correct then all extractions copy the region verbatim and then the server only have to figure out how to "glue" that to a semantically correct call/argument list.</p>
</div>
<div class="paragraph">
<p>As a side note the editor asks for a new name for the function and then calls the edit server with a rename request (having preloaded the new source file(s) of course).</p>
</div>
</div>
<div class="sect3">
<h4 id="_protocol_2">Protocol</h4>
<div class="paragraph">
<p>Dechiffrering the interaction between an editor and the edit server in
<code>c-xrefactory</code> isn&#8217;t easy. The protocol isn&#8217;t very clear or
concise. Here I&#8217;m starting to collect the important bits of the
invocation, the required and relevant options and the returned
information.</p>
</div>
<div class="paragraph">
<p>The test cases for various refactoring operations should give you some
more details.</p>
</div>
<div class="paragraph">
<p>All of these require a <code>-p</code> (project) option to know which c-xref
project options to read.</p>
</div>
<div class="sect4">
<h5 id="_general_principles">General Principles</h5>
<div class="paragraph">
<p>Refactorings are done using a separate invocation, the edit server
mode cannot handle refactorings. At least that is how the Emacs client
does it (haven&#8217;t looked at the Jedit version).</p>
</div>
<div class="paragraph">
<p>I suspect that it once was a single server that did both the symbol
management and the refactoring as there are remnants of a separate
instance of the option structure named "refactoringOptions". Also the
check for the refactoring mode is done using
<code>options.refactoringRegime == RegimeRefactory</code> which seems strange.</p>
</div>
<div class="paragraph">
<p>Anyway, if the refactoring succeeds the suggested edits is as per usual
in the communications buffer.</p>
</div>
<div class="paragraph">
<p>However, there are a couple of cases where the communcation does not
end there. Possibly because the client needs to communicate some
information back before the refactoring server can finish the job,
like presenting some menu selection.</p>
</div>
<div class="paragraph">
<p>My guess at this point is that it is the refactoring
server that closes the connection when it is done&#8230;&#8203;</p>
</div>
</div>
<div class="sect4">
<h5 id="_rename">Rename</h5>
<div class="paragraph">
<p><strong>Invocation:</strong> <code>-rfct-rename -renameto=NEW_NAME -olcursor=POSITION FILE</code></p>
</div>
<div class="paragraph">
<p><strong>Semantics:</strong> The symbol under the cursor (at POSITION in FILE) should
be renamed (replaced at all occurrences) by NEW_NAME.</p>
</div>
<div class="paragraph">
<p><strong>Result:</strong> sequence of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;goto&gt;
 &lt;position-off off=POSITION len=N&gt;FILE&lt;/position-off&gt;
&lt;/goto&gt;
&lt;precheck len=N&gt;STRING&lt;/precheck&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>followed by sequence of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;goto&gt;
 &lt;position-off off=POSITION len=N&gt;FILE&lt;/position-off&gt;
&lt;/goto&gt;
&lt;replacement&gt;
 &lt;str len=N&gt;ORIGINAL&lt;/str&gt;  &lt;str len=N&gt;REPLACEMENT&lt;/str&gt;
&lt;/replacement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_protocol_messages">Protocol Messages</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;goto&gt;{position-off}&lt;/goto&gt; &#8594; editor</dt>
<dd>
<p>Request the editor to move cursor to the indicated position (file, position).</p>
</dd>
<dt class="hdlist1">&lt;precheck len={int}&gt;{string}&lt;/precheck&gt; &#8594; editor</dt>
<dd>
<p>Requests that the editor verifies that the text under the cursor matches the string.</p>
</dd>
<dt class="hdlist1">&lt;replacement&gt;{str}{str}&lt;/replacement&gt;</dt>
<dd>
<p>Requests that the editor replaces the string under the cursor, which should be 'string1', with 'string2'.</p>
</dd>
<dt class="hdlist1">&lt;position-off off={int} len={int}&gt;{absolute path to file}&lt;/position-off&gt;</dt>
<dd>
<p>Indicates a position in the given file. 'off' is the character position in the file.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_memory_management">Memory Management</h3>
<div class="paragraph">
<p>There are multiple levels of memory management.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Why is this required (possibly because of the long running server
model)?</p>
</li>
<li>
<p>Exactly how is this memory allocated?</p>
</li>
<li>
<p>Why handle this allocation in disparate spaces?</p>
</li>
<li>
<p>Why does not standard malloc()/free() suffice?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is obviously some caching going on. Don&#8217;t know of what at this
point. Tag data?</p>
</div>
<div class="sect3">
<h4 id="_memory_types">Memory "types"</h4>
<div class="paragraph">
<p>Mostly <code>c-xrefactory</code> does its own memory management. It uses a number
of different strategies, which has/had its own macros.</p>
</div>
<div class="sect4">
<h5 id="_static_memory">"Static" memory</h5>
<div class="paragraph">
<p>For the memory usages where the size of the total area is static all
memory handling macros have been refactored int functions using the
<code>Memory2</code> struct for administration.</p>
</div>
<div class="paragraph">
<p>For <code>ft</code> (file table), <code>ppm</code> (pre-processor macro) and <code>cf</code> (class
file) memory usages all uses the new <code>Memory2</code> for their memory
administration. Functions with the mentioned prefixes are just
convenience functions that works on the corresponding memory
administraion structure.</p>
</div>
</div>
<div class="sect4">
<h5 id="_dynamic_memory_allocation">Dynamic memory allocation</h5>
<div class="paragraph">
<p>The <code>Memory</code> structure is used for one of the two dynamic memory
allocation schemes, where overflow handling can be triggered. The
structure contains a function pointer that can be invoked when
overflow occurs.</p>
</div>
<div class="paragraph">
<p><code>dm_alloc()</code>, previously a macro, returns pointers into that area.</p>
</div>
<div class="paragraph">
<p>There are two instances of this type of memory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cxMemory</code> - the crossreference data, which can actually expand using
the <code>cxMemoryOverflowHandler()</code></p>
</li>
<li>
<p><code>optMemory</code> - which is part of the options structure that is saved,
copied and what not, cannot expand as the overflow handler calls
<code>fatalError()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>cxMemoryOverflowHandler()</code> on the other hand, just throws all
cxMemory away and allocates a new, larger, area containing a fresh
Memory structure as the head and an empty area to allocate from.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_malloc">Using malloc()</h5>
<div class="paragraph">
<p>There is a second type of dynamic memory, of which there is only one,
the <code>olcxMemory</code>. In fact, this is not actually an area, more like a
normal dynamic allocation. Each area is just <code>malloc()</code>-ed, but the
size is tallied and when the maximum is reached <code>olcx_memory_alloc()</code>
will do a fatal exit.</p>
</div>
<div class="paragraph">
<p>This memory allocation is used for temporary areas during refactorings
for example. So <code>olcx_memory_free()</code> also exist and is used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_option_memory">Option Memory</h4>
<div class="paragraph">
<p>The memory handling for options deserves special explanation and attention.</p>
</div>
<div class="paragraph">
<p>When defining options, from the command line, options file or piped
from an editor process, the strings need to be preserved and
stored. This is done by "dynamically" allocating such areas in the
"options memory", <code>optMemory</code>.</p>
</div>
<div class="paragraph">
<p>But since this is a integral part of the options structure, whenever
an <code>Options</code> structure is copied, special care has to be taken so that
the fields in the target structure points into the memory area of the
target structure and not, as they did in the original structure, into
the memory of the source structure.</p>
</div>
<div class="paragraph">
<p>There are functions that, through tricky memory arithmetic, adjust all
pointers to point correctly. To this end, all memory locations in an
<code>Options</code> structure are collected in a linked list which can be
traversed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
the nodes in the linked list are also allocated in the "dynamic"
memory of the Options structure.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">Configuration</h3>
<div class="sect3">
<h4 id="_options">Options</h4>
<div class="paragraph">
<p>There are three possible sources for options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration files (~/.c-xrefrc)</p>
</li>
<li>
<p>Piped options sent to edit server</p>
</li>
<li>
<p>Command line options</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all options are relevant in all cases.</p>
</div>
<div class="paragraph">
<p>All options sources uses exactly the same format so that the same code for decoding them can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_logic">Logic</h4>
<div class="paragraph">
<p>When the editor has a file open it needs to "belong" to a project. The
logic for finding which is very intricate and complicated.</p>
</div>
<div class="paragraph">
<p>In this code there is also checks for things like if the file is
already in the index, if the configuration file has changed since last
time, indicating there are scenarios that are more complicated (the
server, obviously).</p>
</div>
<div class="paragraph">
<p>But I also think this code should be simplified a lot.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-04-30 22:16:15 UTC
</div>
</div>
</body>
</html>