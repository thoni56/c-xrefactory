#! /bin/bash
# Run an autodiscovered test in the c-xrefactory test suite
# args: 1 = test (directory) name
#
# Environment variables:
#       GCOV_OPTIONS such as "GCOV_PREFIX=<path> GCOV_PREFIX_STRIP=6"
#
# Checks if the test is suspended and runs with the GCOV_OPTIONS

# TODO check for gcov-tool compatible with compiler used:

if [ -f $1/.suspended ] ; then
    echo "Tests in '$1': `tput setaf 6`SUSPENDED`tput sgr0`"
else
    mkdir -p $1/.cov
    
    # Darwin: Set environment variable for profraw output location
    if [[ "$OSTYPE" == "darwin"* ]]; then
        export LLVM_PROFILE_FILE=$1/.cov/test_%p.profraw
    fi
    
    make --no-print-directory $GCOV_OPTIONS -C $1
    rc=$?
    if [ $rc -ne 0 ] ; then
	    exit $rc
    fi
    
    # Handle coverage collection based on platform
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # Darwin: profraw files are already in .cov directory
        # No additional processing needed - merging happens in main Makefile
        :
    elif ! command -v gcov-tool &> /dev/null ; then
	cd $1
	eval export $GCOV_OPTIONS
	# Then we create a coverage.info for this test
	# Use inherited LCOV variable which already contains version-specific flags
	eval "$LCOV -q -c -d .cov -b ../../src --build-directory ../../src/.objects -o .cov/coverage.info" 2>&1 > /dev/null
    fi
fi
